var gracefulQueue,previousSymbol,fs=require("fs"),polyfills=require("./polyfills.js"),legacy=require("./legacy-streams.js"),clone=require("./clone.js"),util=require("util");function noop(){}function publishQueue(e,t){Object.defineProperty(e,gracefulQueue,{get:function(){return t}})}"function"==typeof Symbol&&"function"==typeof Symbol.for?(gracefulQueue=Symbol.for("graceful-fs.queue"),previousSymbol=Symbol.for("graceful-fs.previous")):(gracefulQueue="___graceful-fs.queue",previousSymbol="___graceful-fs.previous");var retryTimer,debug=noop;if(util.debuglog?debug=util.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(debug=function(){var e=util.format.apply(util,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: "),console.error(e)}),!fs[gracefulQueue]){var queue=global[gracefulQueue]||[];publishQueue(fs,queue),fs.close=function(e){function t(t,n){return e.call(fs,t,function(e){e||resetQueue(),"function"==typeof n&&n.apply(this,arguments)})}return Object.defineProperty(t,previousSymbol,{value:e}),t}(fs.close),fs.closeSync=function(e){function t(t){e.apply(fs,arguments),resetQueue()}return Object.defineProperty(t,previousSymbol,{value:e}),t}(fs.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",function(){debug(fs[gracefulQueue]),require("assert").equal(fs[gracefulQueue].length,0)})}function patch(e){polyfills(e),e.gracefulify=patch,e.createReadStream=function(t,n){return new e.ReadStream(t,n)},e.createWriteStream=function(t,n){return new e.WriteStream(t,n)};var t=e.readFile;e.readFile=function(e,n,u){"function"==typeof n&&(u=n,n=null);return function e(n,u,r,o){return t(n,u,function(t){!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?"function"==typeof r&&r.apply(this,arguments):enqueue([e,[n,u,r],t,o||Date.now(),Date.now()])})}(e,n,u)};var n=e.writeFile;e.writeFile=function(e,t,u,r){"function"==typeof u&&(r=u,u=null);return function e(t,u,r,o,f){return n(t,u,r,function(n){!n||"EMFILE"!==n.code&&"ENFILE"!==n.code?"function"==typeof o&&o.apply(this,arguments):enqueue([e,[t,u,r,o],n,f||Date.now(),Date.now()])})}(e,t,u,r)};var u=e.appendFile;u&&(e.appendFile=function(e,t,n,r){"function"==typeof n&&(r=n,n=null);return function e(t,n,r,o,f){return u(t,n,r,function(u){!u||"EMFILE"!==u.code&&"ENFILE"!==u.code?"function"==typeof o&&o.apply(this,arguments):enqueue([e,[t,n,r,o],u,f||Date.now(),Date.now()])})}(e,t,n,r)});var r=e.copyFile;r&&(e.copyFile=function(e,t,n,u){"function"==typeof n&&(u=n,n=0);return function e(t,n,u,o,f){return r(t,n,u,function(r){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?"function"==typeof o&&o.apply(this,arguments):enqueue([e,[t,n,u,o],r,f||Date.now(),Date.now()])})}(e,t,n,u)});var o=e.readdir;e.readdir=function(e,t,n){"function"==typeof t&&(n=t,t=null);var u=f.test(process.version)?function(e,t,n,u){return o(e,r(e,t,n,u))}:function(e,t,n,u){return o(e,t,r(e,t,n,u))};return u(e,t,n);function r(e,t,n,r){return function(o,f){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?(f&&f.sort&&f.sort(),"function"==typeof n&&n.call(this,o,f)):enqueue([u,[e,t,n],o,r||Date.now(),Date.now()])}}};var f=/^v[0-5]\./;if("v0.8"===process.version.substr(0,4)){var i=legacy(e);p=i.ReadStream,y=i.WriteStream}var c=e.ReadStream;c&&(p.prototype=Object.create(c.prototype),p.prototype.open=function(){var e=this;d(e.path,e.flags,e.mode,function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())})});var a=e.WriteStream;a&&(y.prototype=Object.create(a.prototype),y.prototype.open=function(){var e=this;d(e.path,e.flags,e.mode,function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))})}),Object.defineProperty(e,"ReadStream",{get:function(){return p},set:function(e){p=e},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WriteStream",{get:function(){return y},set:function(e){y=e},enumerable:!0,configurable:!0});var l=p;Object.defineProperty(e,"FileReadStream",{get:function(){return l},set:function(e){l=e},enumerable:!0,configurable:!0});var s=y;function p(e,t){return this instanceof p?(c.apply(this,arguments),this):p.apply(Object.create(p.prototype),arguments)}function y(e,t){return this instanceof y?(a.apply(this,arguments),this):y.apply(Object.create(y.prototype),arguments)}Object.defineProperty(e,"FileWriteStream",{get:function(){return s},set:function(e){s=e},enumerable:!0,configurable:!0});var g=e.open;function d(e,t,n,u){return"function"==typeof n&&(u=n,n=null),function e(t,n,u,r,o){return g(t,n,u,function(f,i){!f||"EMFILE"!==f.code&&"ENFILE"!==f.code?"function"==typeof r&&r.apply(this,arguments):enqueue([e,[t,n,u,r],f,o||Date.now(),Date.now()])})}(e,t,n,u)}return e.open=d,e}function enqueue(e){debug("ENQUEUE",e[0].name,e[1]),fs[gracefulQueue].push(e),retry()}function resetQueue(){for(var e=Date.now(),t=0;t<fs[gracefulQueue].length;++t)fs[gracefulQueue][t].length>2&&(fs[gracefulQueue][t][3]=e,fs[gracefulQueue][t][4]=e);retry()}function retry(){if(clearTimeout(retryTimer),retryTimer=void 0,0!==fs[gracefulQueue].length){var e=fs[gracefulQueue].shift(),t=e[0],n=e[1],u=e[2],r=e[3],o=e[4];if(void 0===r)debug("RETRY",t.name,n),t.apply(null,n);else if(Date.now()-r>=6e4){debug("TIMEOUT",t.name,n);var f=n.pop();"function"==typeof f&&f.call(null,u)}else{var i=Date.now()-o,c=Math.max(o-r,1);i>=Math.min(1.2*c,100)?(debug("RETRY",t.name,n),t.apply(null,n.concat([r]))):fs[gracefulQueue].push(e)}void 0===retryTimer&&(retryTimer=setTimeout(retry,0))}}global[gracefulQueue]||publishQueue(global,fs[gracefulQueue]),module.exports=patch(clone(fs)),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!fs.__patched&&(module.exports=patch(fs),fs.__patched=!0);