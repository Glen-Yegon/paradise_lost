var constants=require("constants"),origCwd=process.cwd,cwd=null,platform=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return cwd||(cwd=origCwd.call(process)),cwd};try{process.cwd()}catch(n){}if("function"==typeof process.chdir){var chdir=process.chdir;process.chdir=function(n){cwd=null,chdir.call(process,n)},Object.setPrototypeOf&&Object.setPrototypeOf(process.chdir,chdir)}function patch(n){var c;function t(c){return c?function(t,o,e){return c.call(n,t,o,function(n){u(n)&&(n=null),e&&e.apply(this,arguments)})}:c}function o(c){return c?function(t,o){try{return c.call(n,t,o)}catch(n){if(!u(n))throw n}}:c}function e(c){return c?function(t,o,e,r){return c.call(n,t,o,e,function(n){u(n)&&(n=null),r&&r.apply(this,arguments)})}:c}function r(c){return c?function(t,o,e){try{return c.call(n,t,o,e)}catch(n){if(!u(n))throw n}}:c}function i(c){return c?function(t,o,e){function r(n,c){c&&(c.uid<0&&(c.uid+=4294967296),c.gid<0&&(c.gid+=4294967296)),e&&e.apply(this,arguments)}return"function"==typeof o&&(e=o,o=null),o?c.call(n,t,o,r):c.call(n,t,r)}:c}function s(c){return c?function(t,o){var e=o?c.call(n,t,o):c.call(n,t);return e&&(e.uid<0&&(e.uid+=4294967296),e.gid<0&&(e.gid+=4294967296)),e}:c}function u(n){return!n||("ENOSYS"===n.code||!(process.getuid&&0===process.getuid()||"EINVAL"!==n.code&&"EPERM"!==n.code))}constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&function(n){n.lchmod=function(c,t,o){n.open(c,constants.O_WRONLY|constants.O_SYMLINK,t,function(c,e){c?o&&o(c):n.fchmod(e,t,function(c){n.close(e,function(n){o&&o(c||n)})})})},n.lchmodSync=function(c,t){var o,e=n.openSync(c,constants.O_WRONLY|constants.O_SYMLINK,t),r=!0;try{o=n.fchmodSync(e,t),r=!1}finally{if(r)try{n.closeSync(e)}catch(n){}else n.closeSync(e)}return o}}(n),n.lutimes||function(n){constants.hasOwnProperty("O_SYMLINK")&&n.futimes?(n.lutimes=function(c,t,o,e){n.open(c,constants.O_SYMLINK,function(c,r){c?e&&e(c):n.futimes(r,t,o,function(c){n.close(r,function(n){e&&e(c||n)})})})},n.lutimesSync=function(c,t,o){var e,r=n.openSync(c,constants.O_SYMLINK),i=!0;try{e=n.futimesSync(r,t,o),i=!1}finally{if(i)try{n.closeSync(r)}catch(n){}else n.closeSync(r)}return e}):n.futimes&&(n.lutimes=function(n,c,t,o){o&&process.nextTick(o)},n.lutimesSync=function(){})}(n),n.chown=e(n.chown),n.fchown=e(n.fchown),n.lchown=e(n.lchown),n.chmod=t(n.chmod),n.fchmod=t(n.fchmod),n.lchmod=t(n.lchmod),n.chownSync=r(n.chownSync),n.fchownSync=r(n.fchownSync),n.lchownSync=r(n.lchownSync),n.chmodSync=o(n.chmodSync),n.fchmodSync=o(n.fchmodSync),n.lchmodSync=o(n.lchmodSync),n.stat=i(n.stat),n.fstat=i(n.fstat),n.lstat=i(n.lstat),n.statSync=s(n.statSync),n.fstatSync=s(n.fstatSync),n.lstatSync=s(n.lstatSync),n.chmod&&!n.lchmod&&(n.lchmod=function(n,c,t){t&&process.nextTick(t)},n.lchmodSync=function(){}),n.chown&&!n.lchown&&(n.lchown=function(n,c,t,o){o&&process.nextTick(o)},n.lchownSync=function(){}),"win32"===platform&&(n.rename="function"!=typeof n.rename?n.rename:function(c){function t(t,o,e){var r=Date.now(),i=0;c(t,o,function s(u){if(u&&("EACCES"===u.code||"EPERM"===u.code||"EBUSY"===u.code)&&Date.now()-r<6e4)return setTimeout(function(){n.stat(o,function(n,r){n&&"ENOENT"===n.code?c(t,o,s):e(u)})},i),void(i<100&&(i+=10));e&&e(u)})}return Object.setPrototypeOf&&Object.setPrototypeOf(t,c),t}(n.rename)),n.read="function"!=typeof n.read?n.read:function(c){function t(t,o,e,r,i,s){var u;if(s&&"function"==typeof s){var f=0;u=function(l,a,d){if(l&&"EAGAIN"===l.code&&f<10)return f++,c.call(n,t,o,e,r,i,u);s.apply(this,arguments)}}return c.call(n,t,o,e,r,i,u)}return Object.setPrototypeOf&&Object.setPrototypeOf(t,c),t}(n.read),n.readSync="function"!=typeof n.readSync?n.readSync:(c=n.readSync,function(t,o,e,r,i){for(var s=0;;)try{return c.call(n,t,o,e,r,i)}catch(n){if("EAGAIN"===n.code&&s<10){s++;continue}throw n}})}module.exports=patch;