var sortSelectors=require("./sort-selectors"),tidyRules=require("./tidy-rules"),tidyBlock=require("./tidy-block"),tidyAtRule=require("./tidy-at-rule"),Hack=require("../hack"),removeUnused=require("../remove-unused"),restoreFromOptimizing=require("../restore-from-optimizing"),wrapForOptimizing=require("../wrap-for-optimizing").all,configuration=require("../configuration"),optimizers=require("./value-optimizers"),OptimizationLevel=require("../../options/optimization-level").OptimizationLevel,Token=require("../../tokenizer/token"),Marker=require("../../tokenizer/marker"),formatPosition=require("../../utils/format-position"),serializeRules=require("../../writer/one-time").rules,CHARSET_TOKEN="@charset",CHARSET_REGEXP=new RegExp("^"+CHARSET_TOKEN,"i"),DEFAULT_ROUNDING_PRECISION=require("../../options/rounding-precision").DEFAULT,VARIABLE_PROPERTY_NAME_PATTERN=/^--\S+$/,PROPERTY_NAME_PATTERN=/^(?:-chrome-|-[\w-]+\w|\w[\w-]+\w|\w{1,})$/,IMPORT_PREFIX_PATTERN=/^@import/i,URL_PREFIX_PATTERN=/^url\(/i;function startsAsUrl(e){return URL_PREFIX_PATTERN.test(e)}function isImport(e){return IMPORT_PREFIX_PATTERN.test(e[1])}function isLegacyFilter(e){var i;return("filter"==e.name||"-ms-filter"==e.name)&&((i=e.value[0][1]).indexOf("progid")>-1||0===i.indexOf("alpha")||0===i.indexOf("chroma"))}function noop(){}function noopValueOptimizer(e,i,t){return i}function optimizeBody(e,i,t){var r,o,n,a,s,l,p,u,m,c,E=t.options,R=serializeRules(e),g=wrapForOptimizing(i),f=t.options.plugins.level1Value,v=t.options.plugins.level1Property;for(m=0,c=g.length;m<c;m++){var T,O,d,h;if(n=(o=g[m]).name,p=configuration[n]&&configuration[n].propertyOptimizer||noop,r=configuration[n]&&configuration[n].valueOptimizers||[optimizers.whiteSpace],(u=VARIABLE_PROPERTY_NAME_PATTERN.test(n))&&(r=E.variableOptimizers.length>0?E.variableOptimizers:[optimizers.whiteSpace]),u||PROPERTY_NAME_PATTERN.test(n))if(0!==o.value.length)if(!o.hack||(o.hack[0]!=Hack.ASTERISK&&o.hack[0]!=Hack.UNDERSCORE||E.compatibility.properties.iePrefixHack)&&(o.hack[0]!=Hack.BACKSLASH||E.compatibility.properties.ieSuffixHack)&&(o.hack[0]!=Hack.BANG||E.compatibility.properties.ieBangHack))if(E.compatibility.properties.ieFilters||!isLegacyFilter(o))if(o.block)optimizeBody(e,o.value[0][1],t);else{for(T=0,d=o.value.length;T<d;T++){if(a=o.value[T][0],s=o.value[T][1],a==Token.PROPERTY_BLOCK){o.unused=!0,t.warnings.push("Invalid value token at "+formatPosition(s[0][1][2][0])+". Ignoring.");break}if(startsAsUrl(s)&&!t.validator.isUrl(s)){o.unused=!0,t.warnings.push("Broken URL '"+s+"' at "+formatPosition(o.value[T][2][0])+". Ignoring.");break}for(O=0,h=r.length;O<h;O++)s=r[O](n,s,E);for(O=0,h=f.length;O<h;O++)s=f[O](n,s,E);o.value[T][1]=s}for(p(R,o,E),T=0,d=v.length;T<d;T++)v[T](R,o,E)}else o.unused=!0;else o.unused=!0;else l=o.all[o.position],t.warnings.push("Empty property '"+n+"' at "+formatPosition(l[1][2][0])+". Ignoring."),o.unused=!0;else l=o.all[o.position],t.warnings.push("Invalid property name '"+n+"' at "+formatPosition(l[1][2][0])+". Ignoring."),o.unused=!0}restoreFromOptimizing(g),removeUnused(g),removeComments(i,E)}function removeComments(e,i){var t,r;for(r=0;r<e.length;r++)(t=e[r])[0]==Token.COMMENT&&(optimizeComment(t,i),0===t[1].length&&(e.splice(r,1),r--))}function optimizeComment(e,i){e[1][2]==Marker.EXCLAMATION&&("all"==i.level[OptimizationLevel.One].specialComments||i.commentsKept<i.level[OptimizationLevel.One].specialComments)?i.commentsKept++:e[1]=[]}function cleanupCharsets(e){for(var i=!1,t=0,r=e.length;t<r;t++){var o=e[t];o[0]==Token.AT_RULE&&(CHARSET_REGEXP.test(o[1])&&(i||-1==o[1].indexOf(CHARSET_TOKEN)?(e.splice(t,1),t--,r--):(i=!0,e.splice(t,1),e.unshift([Token.AT_RULE,o[1].replace(CHARSET_REGEXP,CHARSET_TOKEN)]))))}}function buildUnitRegexp(e){var i=["px","em","ex","cm","mm","in","pt","pc","%"];return["ch","rem","vh","vm","vmax","vmin","vw"].forEach(function(t){e.compatibility.units[t]&&i.push(t)}),new RegExp("(^|\\s|\\(|,)0(?:"+i.join("|")+")(\\W|$)","g")}function buildPrecisionOptions(e){var i,t,r={matcher:null,units:{}},o=[];for(i in e)(t=e[i])!=DEFAULT_ROUNDING_PRECISION&&(r.units[i]={},r.units[i].value=t,r.units[i].multiplier=10**t,o.push(i));return o.length>0&&(r.enabled=!0,r.decimalPointMatcher=new RegExp("(\\d)\\.($|"+o.join("|")+")($|\\W)","g"),r.zeroMatcher=new RegExp("(\\d*)(\\.\\d+)("+o.join("|")+")","g")),r}function buildVariableOptimizers(e){return e.level[OptimizationLevel.One].variableValueOptimizers.map(function(e){return"string"==typeof e?optimizers[e]||noopValueOptimizer:e})}function level1Optimize(e,i){var t=i.options,r=t.level[OptimizationLevel.One],o=t.compatibility.selectors.ie7Hack,n=t.compatibility.selectors.adjacentSpace,a=t.compatibility.properties.spaceAfterClosingBrace,s=t.format,l=!1,p=!1;t.unitsRegexp=t.unitsRegexp||buildUnitRegexp(t),t.precision=t.precision||buildPrecisionOptions(r.roundingPrecision),t.commentsKept=t.commentsKept||0,t.variableOptimizers=t.variableOptimizers||buildVariableOptimizers(t);for(var u=0,m=e.length;u<m;u++){var c=e[u];switch(c[0]){case Token.AT_RULE:c[1]=isImport(c)&&p?"":c[1],c[1]=r.tidyAtRules?tidyAtRule(c[1]):c[1],l=!0;break;case Token.AT_RULE_BLOCK:optimizeBody(c[1],c[2],i),p=!0;break;case Token.NESTED_BLOCK:c[1]=r.tidyBlockScopes?tidyBlock(c[1],a):c[1],level1Optimize(c[2],i),p=!0;break;case Token.COMMENT:optimizeComment(c,t);break;case Token.RULE:c[1]=r.tidySelectors?tidyRules(c[1],!o,n,s,i.warnings):c[1],c[1]=c[1].length>1?sortSelectors(c[1],r.selectorsSortingMethod):c[1],optimizeBody(c[1],c[2],i),p=!0}(c[0]==Token.COMMENT&&0===c[1].length||r.removeEmpty&&(0===c[1].length||c[2]&&0===c[2].length))&&(e.splice(u,1),u--,m--)}return r.cleanupCharsets&&l&&cleanupCharsets(e),e}module.exports=level1Optimize;