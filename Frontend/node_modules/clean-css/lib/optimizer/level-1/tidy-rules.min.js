var Spaces=require("../../options/format").Spaces,Marker=require("../../tokenizer/marker"),formatPosition=require("../../utils/format-position"),CASE_ATTRIBUTE_PATTERN=/[\s"'][iI]\s*\]/,CASE_RESTORE_PATTERN=/([\d\w])([iI])\]/g,DOUBLE_QUOTE_CASE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"([iI])/g,DOUBLE_QUOTE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"(\s|\])/g,HTML_COMMENT_PATTERN=/^(?:(?:<!--|-->)\s*)+/,SINGLE_QUOTE_CASE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'([iI])/g,SINGLE_QUOTE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'(\s|\])/g,RELATION_PATTERN=/[>+~]/,WHITESPACE_PATTERN=/\s/,ASTERISK_PLUS_HTML_HACK="*+html ",ASTERISK_FIRST_CHILD_PLUS_HTML_HACK="*:first-child+html ",LESS_THAN="<",PSEUDO_CLASSES_WITH_SELECTORS=[":current",":future",":has",":host",":host-context",":is",":not",":past",":where"];function hasInvalidCharacters(e){var r,t,a,E,s=!1,n=!1;for(a=0,E=e.length;a<E;a++){if(t=e[a],r);else if(t==Marker.SINGLE_QUOTE||t==Marker.DOUBLE_QUOTE)n=!n;else{if(!(n||t!=Marker.CLOSE_CURLY_BRACKET&&t!=Marker.EXCLAMATION&&t!=LESS_THAN&&t!=Marker.SEMICOLON)){s=!0;break}if(!n&&0===a&&RELATION_PATTERN.test(t)){s=!0;break}}r=t==Marker.BACK_SLASH}return s}function removeWhitespace(e,r){var t,a,E,s,n,T,_,i,l,o,h,p,A,S,c=[],f=0,O=!1,R=!1,u=!1,C=CASE_ATTRIBUTE_PATTERN.test(e),N=r&&r.spaces[Spaces.AroundSelectorRelation];for(A=0,S=e.length;A<S;A++){if(a=(t=e[A])==Marker.NEW_LINE_NIX,E=t==Marker.NEW_LINE_NIX&&e[A-1]==Marker.CARRIAGE_RETURN,T=_||i,o=!l&&!s&&0===f&&RELATION_PATTERN.test(t),h=WHITESPACE_PATTERN.test(t),p=(1!=f||t!=Marker.CLOSE_ROUND_BRACKET)&&(p||0===f&&t==Marker.COLON&&isPseudoClassWithSelectors(e,A)),n&&T&&E)c.pop(),c.pop();else if(s&&T&&a)c.pop();else if(s)c.push(t);else if(t!=Marker.OPEN_SQUARE_BRACKET||T)if(t!=Marker.CLOSE_SQUARE_BRACKET||T)if(t!=Marker.OPEN_ROUND_BRACKET||T)if(t!=Marker.CLOSE_ROUND_BRACKET||T)if(t!=Marker.SINGLE_QUOTE||T)if(t!=Marker.DOUBLE_QUOTE||T)if(t==Marker.SINGLE_QUOTE&&T)c.push(t),_=!1;else if(t==Marker.DOUBLE_QUOTE&&T)c.push(t),i=!1;else{if(h&&R&&!N)continue;!h&&R&&N?(c.push(Marker.SPACE),c.push(t)):h&&!u&&O&&f>0&&p||(h&&!u&&f>0&&p?c.push(t):h&&(l||f>0)&&!T||h&&u&&!T||(E||a)&&(l||f>0)&&T||(o&&u&&!N?(c.pop(),c.push(t)):o&&!u&&N?(c.push(Marker.SPACE),c.push(t)):h?c.push(Marker.SPACE):c.push(t)))}else c.push(t),i=!0;else c.push(t),_=!0;else c.push(t),f--;else c.push(t),f++;else c.push(t),l=!1;else c.push(t),l=!0;n=s,s=t==Marker.BACK_SLASH,R=o,u=h,O=t==Marker.COMMA}return C?c.join("").replace(CASE_RESTORE_PATTERN,"$1 $2]"):c.join("")}function isPseudoClassWithSelectors(e,r){var t=e.substring(r,e.indexOf(Marker.OPEN_ROUND_BRACKET,r));return PSEUDO_CLASSES_WITH_SELECTORS.indexOf(t)>-1}function removeQuotes(e){return-1==e.indexOf("'")&&-1==e.indexOf('"')?e:e.replace(SINGLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(SINGLE_QUOTE_PATTERN,"=$1$2").replace(DOUBLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(DOUBLE_QUOTE_PATTERN,"=$1$2")}function replacePseudoClasses(e){return e.replace("nth-child(1)","first-child").replace("nth-of-type(1)","first-of-type").replace("nth-of-type(even)","nth-of-type(2n)").replace("nth-child(even)","nth-child(2n)").replace("nth-of-type(2n+1)","nth-of-type(odd)").replace("nth-child(2n+1)","nth-child(odd)").replace("nth-last-child(1)","last-child").replace("nth-last-of-type(1)","last-of-type").replace("nth-last-of-type(even)","nth-last-of-type(2n)").replace("nth-last-child(even)","nth-last-child(2n)").replace("nth-last-of-type(2n+1)","nth-last-of-type(odd)").replace("nth-last-child(2n+1)","nth-last-child(odd)")}function tidyRules(e,r,t,a,E){var s=[],n=[];function T(e,r){return E.push("HTML comment '"+r+"' at "+formatPosition(e[2][0])+". Removing."),""}for(var _=0,i=e.length;_<i;_++){var l=e[_],o=l[1];hasInvalidCharacters(o=o.replace(HTML_COMMENT_PATTERN,T.bind(null,l)))?E.push("Invalid selector '"+l[1]+"' at "+formatPosition(l[2][0])+". Ignoring."):(o=removeQuotes(o=removeWhitespace(o,a)),t&&o.indexOf("nav")>0&&(o=o.replace(/\+nav(\S|$)/,"+ nav$1")),r&&o.indexOf(ASTERISK_PLUS_HTML_HACK)>-1||r&&o.indexOf(ASTERISK_FIRST_CHILD_PLUS_HTML_HACK)>-1||(o.indexOf("*")>-1&&(o=o.replace(/\*([:#.[])/g,"$1").replace(/^(:first-child)?\+html/,"*$1+html")),n.indexOf(o)>-1||(o=replacePseudoClasses(o),l[1]=o,n.push(o),s.push(l))))}return 1==s.length&&0===s[0][1].length&&(E.push("Empty selector '"+s[0][1]+"' at "+formatPosition(s[0][2][0])+". Ignoring."),s=[]),s}module.exports=tidyRules;