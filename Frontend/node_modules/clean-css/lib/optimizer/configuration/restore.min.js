var shallowClone=require("../clone").shallow,Token=require("../../tokenizer/token"),Marker=require("../../tokenizer/marker");function isInheritOnly(e){for(var a=0,l=e.length;a<l;a++){var u=e[a][1];if("inherit"!=u&&u!=Marker.COMMA&&u!=Marker.FORWARD_SLASH)return!1}return!0}function background(e,a,l){var u,n,r=e.components,t=[];function o(e){Array.prototype.unshift.apply(t,e.value)}function v(e){var l=a[e.name];return l.doubleValues&&1==l.defaultValue.length?e.value[0][1]==l.defaultValue[0]&&(!e.value[1]||e.value[1][1]==l.defaultValue[0]):l.doubleValues&&1!=l.defaultValue.length?e.value[0][1]==l.defaultValue[0]&&(e.value[1]?e.value[1][1]:e.value[0][1])==l.defaultValue[1]:e.value[0][1]==l.defaultValue}for(var s=r.length-1;s>=0;s--){var f=r[s],p=v(f);if("background-clip"==f.name){var i=r[s-1],h=v(i);n=!(u=f.value[0][1]==i.value[0][1])&&(h&&!p||!h&&!p||!h&&p&&f.value[0][1]!=i.value[0][1]),u?o(i):n&&(o(f),o(i)),s--}else if("background-size"==f.name){var c=r[s-1],k=v(c);n=!(u=!k&&p)&&(k&&!p||!k&&!p),u?o(c):n?(o(f),t.unshift([Token.PROPERTY_VALUE,Marker.FORWARD_SLASH]),o(c)):1==c.value.length&&o(c),s--}else{if(p||a[f.name].multiplexLastOnly&&!l)continue;o(f)}}return 0===t.length&&1==e.value.length&&"0"==e.value[0][1]&&t.push(e.value[0]),0===t.length&&t.push([Token.PROPERTY_VALUE,a[e.name].defaultValue]),isInheritOnly(t)?[t[0]]:t}function borderRadius(e){if(e.multiplex){for(var a=shallowClone(e),l=shallowClone(e),u=0;u<4;u++){var n=e.components[u],r=shallowClone(e);r.value=[n.value[0]],a.components.push(r);var t=shallowClone(e);t.value=[n.value[1]||n.value[0]],l.components.push(t)}var o=fourValues(a),v=fourValues(l);return o.length!=v.length||o[0][1]!=v[0][1]||o.length>1&&o[1][1]!=v[1][1]||o.length>2&&o[2][1]!=v[2][1]||o.length>3&&o[3][1]!=v[3][1]?o.concat([[Token.PROPERTY_VALUE,Marker.FORWARD_SLASH]]).concat(v):o}return fourValues(e)}function font(e,a){var l,u=e.components,n=[],r=0,t=0;if(0===e.value[0][1].indexOf(Marker.INTERNAL))return e.value[0][1]=e.value[0][1].substring(Marker.INTERNAL.length),e.value;for(;r<4;)(l=u[r]).value[0][1]!=a[l.name].defaultValue&&Array.prototype.push.apply(n,l.value),r++;for(Array.prototype.push.apply(n,u[r].value),u[++r].value[0][1]!=a[u[r].name].defaultValue&&(Array.prototype.push.apply(n,[[Token.PROPERTY_VALUE,Marker.FORWARD_SLASH]]),Array.prototype.push.apply(n,u[r].value)),r++;u[r].value[t];)n.push(u[r].value[t]),u[r].value[t+1]&&n.push([Token.PROPERTY_VALUE,Marker.COMMA]),t++;return isInheritOnly(n)?[n[0]]:n}function fourValues(e){var a=e.components,l=a[0].value[0],u=a[1].value[0],n=a[2].value[0],r=a[3].value[0];return l[1]==u[1]&&l[1]==n[1]&&l[1]==r[1]?[l]:l[1]==n[1]&&u[1]==r[1]?[l,u]:u[1]==r[1]?[l,u,n]:[l,u,n,r]}function multiplex(e){return function(a,l){if(!a.multiplex)return e(a,l,!0);var u,n,r=0,t=[],o={};for(u=0,n=a.components[0].value.length;u<n;u++)a.components[0].value[u][1]==Marker.COMMA&&r++;for(u=0;u<=r;u++){for(var v=shallowClone(a),s=0,f=a.components.length;s<f;s++){var p=a.components[s],i=shallowClone(p);v.components.push(i);for(var h=o[i.name]||0,c=p.value.length;h<c;h++){if(p.value[h][1]==Marker.COMMA){o[i.name]=h+1;break}i.value.push(p.value[h])}}var k=e(v,l,u==r);Array.prototype.push.apply(t,k),u<r&&t.push([Token.PROPERTY_VALUE,Marker.COMMA])}return t}}function withoutDefaults(e,a){for(var l=e.components,u=[],n=l.length-1;n>=0;n--){var r=l[n],t=a[r.name];(r.value[0][1]!=t.defaultValue||"keepUnlessDefault"in t&&!isDefault(l,a,t.keepUnlessDefault))&&u.unshift(r.value[0])}return 0===u.length&&u.push([Token.PROPERTY_VALUE,a[e.name].defaultValue]),isInheritOnly(u)?[u[0]]:u}function isDefault(e,a,l){var u,n,r;for(n=0,r=e.length;n<r;n++)if((u=e[n]).name==l&&u.value[0][1]==a[l].defaultValue)return!0;return!1}module.exports={background:background,borderRadius:borderRadius,font:font,fourValues:fourValues,multiplex:multiplex,withoutDefaults:withoutDefaults};