var InvalidPropertyError=require("../invalid-property-error"),wrapSingle=require("../wrap-for-optimizing").single,Token=require("../../tokenizer/token"),Marker=require("../../tokenizer/marker"),formatPosition=require("../../utils/format-position");function _anyIsInherit(e){var a,i;for(a=0,i=e.length;a<i;a++)if("inherit"==e[a][1])return!0;return!1}function _colorFilter(e){return function(a){return"invert"==a[1]||e.isColor(a[1])||e.isPrefixed(a[1])}}function _styleFilter(e){return function(a){return"inherit"!=a[1]&&e.isStyleKeyword(a[1])&&!e.isColorFunction(a[1])}}function _wrapDefault(e,a,i){var n=i[e];return n.doubleValues&&2==n.defaultValue.length?wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,e],[Token.PROPERTY_VALUE,n.defaultValue[0]],[Token.PROPERTY_VALUE,n.defaultValue[1]]]):n.doubleValues&&1==n.defaultValue.length?wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,e],[Token.PROPERTY_VALUE,n.defaultValue[0]]]):wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,e],[Token.PROPERTY_VALUE,n.defaultValue]])}function _widthFilter(e){return function(a){return"inherit"!=a[1]&&(e.isWidth(a[1])||e.isUnit(a[1])||e.isDynamicUnit(a[1]))&&!e.isStyleKeyword(a[1])&&!e.isColorFunction(a[1])}}function animation(e,a,i){var n,r,t,l=_wrapDefault(e.name+"-duration",e,a),o=_wrapDefault(e.name+"-timing-function",e,a),u=_wrapDefault(e.name+"-delay",e,a),s=_wrapDefault(e.name+"-iteration-count",e,a),f=_wrapDefault(e.name+"-direction",e,a),v=_wrapDefault(e.name+"-fill-mode",e,a),g=_wrapDefault(e.name+"-play-state",e,a),d=_wrapDefault(e.name+"-name",e,a),p=[l,o,u,s,f,v,g,d],h=e.value,w=!1,c=!1,m=!1,y=!1,_=!1,P=!1,I=!1,k=!1;if(1==e.value.length&&"inherit"==e.value[0][1])return l.value=o.value=u.value=s.value=f.value=v.value=g.value=d.value=e.value,p;if(h.length>1&&_anyIsInherit(h))throw new InvalidPropertyError("Invalid animation values at "+formatPosition(h[0][2][0])+". Ignoring.");for(r=0,t=h.length;r<t;r++)if(n=h[r],i.isTime(n[1])&&!w)l.value=[n],w=!0;else if(i.isTime(n[1])&&!m)u.value=[n],m=!0;else if(!i.isGlobal(n[1])&&!i.isTimingFunction(n[1])||c)if(!i.isAnimationIterationCountKeyword(n[1])&&!i.isPositiveNumber(n[1])||y)if(i.isAnimationDirectionKeyword(n[1])&&!_)f.value=[n],_=!0;else if(i.isAnimationFillModeKeyword(n[1])&&!P)v.value=[n],P=!0;else if(i.isAnimationPlayStateKeyword(n[1])&&!I)g.value=[n],I=!0;else{if(!i.isAnimationNameKeyword(n[1])&&!i.isIdentifier(n[1])||k)throw new InvalidPropertyError("Invalid animation value at "+formatPosition(n[2][0])+". Ignoring.");d.value=[n],k=!0}else s.value=[n],y=!0;else o.value=[n],c=!0;return p}function background(e,a,i){var n=_wrapDefault("background-image",e,a),r=_wrapDefault("background-position",e,a),t=_wrapDefault("background-size",e,a),l=_wrapDefault("background-repeat",e,a),o=_wrapDefault("background-attachment",e,a),u=_wrapDefault("background-origin",e,a),s=_wrapDefault("background-clip",e,a),f=_wrapDefault("background-color",e,a),v=[n,r,t,l,o,u,s,f],g=e.value,d=!1,p=!1,h=!1,w=!1,c=!1;if(1==e.value.length&&"inherit"==e.value[0][1])return f.value=n.value=l.value=r.value=t.value=u.value=s.value=e.value,v;if(1==e.value.length&&"0 0"==e.value[0][1])return v;for(var m=g.length-1;m>=0;m--){var y=g[m];if(i.isBackgroundAttachmentKeyword(y[1]))o.value=[y],c=!0;else if(i.isBackgroundClipKeyword(y[1])||i.isBackgroundOriginKeyword(y[1]))p?(u.value=[y],h=!0):(s.value=[y],p=!0),c=!0;else if(i.isBackgroundRepeatKeyword(y[1]))w?l.value.unshift(y):(l.value=[y],w=!0),c=!0;else if(i.isBackgroundPositionKeyword(y[1])||i.isBackgroundSizeKeyword(y[1])||i.isUnit(y[1])||i.isDynamicUnit(y[1])){if(m>0){var _=g[m-1];_[1]==Marker.FORWARD_SLASH?t.value=[y]:m>1&&g[m-2][1]==Marker.FORWARD_SLASH?(t.value=[_,y],m-=2):(d||(r.value=[]),r.value.unshift(y),d=!0)}else d||(r.value=[]),r.value.unshift(y),d=!0;c=!0}else f.value[0][1]!=a[f.name].defaultValue&&"none"!=f.value[0][1]||!i.isColor(y[1])&&!i.isPrefixed(y[1])?(i.isUrl(y[1])||i.isFunction(y[1]))&&(n.value=[y],c=!0):(f.value=[y],c=!0)}if(p&&!h&&(u.value=s.value.slice(0)),!c)throw new InvalidPropertyError("Invalid background value at "+formatPosition(g[0][2][0])+". Ignoring.");return v}function borderRadius(e,a){for(var i=e.value,n=-1,r=0,t=i.length;r<t;r++)if(i[r][1]==Marker.FORWARD_SLASH){n=r;break}if(0===n||n===i.length-1)throw new InvalidPropertyError("Invalid border-radius value at "+formatPosition(i[0][2][0])+". Ignoring.");var l=_wrapDefault(e.name,e,a);l.value=n>-1?i.slice(0,n):i.slice(0),l.components=fourValues(l,a);var o=_wrapDefault(e.name,e,a);o.value=n>-1?i.slice(n+1):i.slice(0),o.components=fourValues(o,a);for(var u=0;u<4;u++)l.components[u].multiplex=!0,l.components[u].value=l.components[u].value.concat(o.components[u].value);return l.components}function font(e,a,i){var n,r,t,l,o=_wrapDefault("font-style",e,a),u=_wrapDefault("font-variant",e,a),s=_wrapDefault("font-weight",e,a),f=_wrapDefault("font-stretch",e,a),v=_wrapDefault("font-size",e,a),g=_wrapDefault("line-height",e,a),d=_wrapDefault("font-family",e,a),p=[o,u,s,f,v,g,d],h=e.value,w=0,c=!1,m=!1,y=!1,_=!1,P=!1;if(!h[w])throw new InvalidPropertyError("Missing font values at "+formatPosition(e.all[e.position][1][2][0])+". Ignoring.");if(1==h.length&&"inherit"==h[0][1])return o.value=u.value=s.value=f.value=v.value=g.value=d.value=h,p;if(1==h.length&&(i.isFontKeyword(h[0][1])||i.isGlobal(h[0][1])||i.isPrefixed(h[0][1])))return h[0][1]=Marker.INTERNAL+h[0][1],o.value=u.value=s.value=f.value=v.value=g.value=d.value=h,p;if(h.length<2||!_anyIsFontSize(h,i)||!_anyIsFontFamily(h,i))throw new InvalidPropertyError("Invalid font values at "+formatPosition(e.all[e.position][1][2][0])+". Ignoring.");if(h.length>1&&_anyIsInherit(h))throw new InvalidPropertyError("Invalid font values at "+formatPosition(h[0][2][0])+". Ignoring.");for(;w<4;){if(n=i.isFontStretchKeyword(h[w][1])||i.isGlobal(h[w][1]),r=i.isFontStyleKeyword(h[w][1])||i.isGlobal(h[w][1]),t=i.isFontVariantKeyword(h[w][1])||i.isGlobal(h[w][1]),l=i.isFontWeightKeyword(h[w][1])||i.isGlobal(h[w][1]),r&&!m)o.value=[h[w]],m=!0;else if(t&&!y)u.value=[h[w]],y=!0;else if(l&&!_)s.value=[h[w]],_=!0;else{if(!n||c){if(r&&m||t&&y||l&&_||n&&c)throw new InvalidPropertyError("Invalid font style / variant / weight / stretch value at "+formatPosition(h[0][2][0])+". Ignoring.");break}f.value=[h[w]],c=!0}w++}if(!(i.isFontSizeKeyword(h[w][1])||i.isUnit(h[w][1])&&!i.isDynamicUnit(h[w][1])))throw new InvalidPropertyError("Missing font size at "+formatPosition(h[0][2][0])+". Ignoring.");if(v.value=[h[w]],!h[++w])throw new InvalidPropertyError("Missing font family at "+formatPosition(h[0][2][0])+". Ignoring.");for(h[w]&&h[w][1]==Marker.FORWARD_SLASH&&h[w+1]&&(i.isLineHeightKeyword(h[w+1][1])||i.isUnit(h[w+1][1])||i.isNumber(h[w+1][1]))&&(g.value=[h[w+1]],w++,w++),d.value=[];h[w];)h[w][1]==Marker.COMMA?P=!1:(P?d.value[d.value.length-1][1]+=Marker.SPACE+h[w][1]:d.value.push(h[w]),P=!0),w++;if(0===d.value.length)throw new InvalidPropertyError("Missing font family at "+formatPosition(h[0][2][0])+". Ignoring.");return p}function _anyIsFontSize(e,a){var i,n,r;for(n=0,r=e.length;n<r;n++)if(i=e[n],a.isFontSizeKeyword(i[1])||a.isUnit(i[1])&&!a.isDynamicUnit(i[1])||a.isFunction(i[1]))return!0;return!1}function _anyIsFontFamily(e,a){var i,n,r;for(n=0,r=e.length;n<r;n++)if(i=e[n],a.isIdentifier(i[1])||a.isQuotedText(i[1]))return!0;return!1}function fourValues(e,a){var i=a[e.name].components,n=[],r=e.value;if(r.length<1)return[];r.length<2&&(r[1]=r[0].slice(0)),r.length<3&&(r[2]=r[0].slice(0)),r.length<4&&(r[3]=r[1].slice(0));for(var t=i.length-1;t>=0;t--){var l=wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,i[t]]]);l.value=[r[t]],n.unshift(l)}return n}function multiplex(e){return function(a,i,n){var r,t,l,o,u=[],s=a.value;for(r=0,l=s.length;r<l;r++)","==s[r][1]&&u.push(r);if(0===u.length)return e(a,i,n);var f=[];for(r=0,l=u.length;r<=l;r++){var v=0===r?0:u[r-1]+1,g=r<l?u[r]:s.length,d=_wrapDefault(a.name,a,i);d.value=s.slice(v,g),d.value.length>0&&f.push(e(d,i,n))}var p=f[0];for(r=0,l=p.length;r<l;r++)for(p[r].multiplex=!0,t=1,o=f.length;t<o;t++)p[r].value.push([Token.PROPERTY_VALUE,Marker.COMMA]),Array.prototype.push.apply(p[r].value,f[t][r].value);return p}}function listStyle(e,a,i){var n=_wrapDefault("list-style-type",e,a),r=_wrapDefault("list-style-position",e,a),t=_wrapDefault("list-style-image",e,a),l=[n,r,t];if(1==e.value.length&&"inherit"==e.value[0][1])return n.value=r.value=t.value=[e.value[0]],l;var o=e.value.slice(0),u=o.length,s=0;for(s=0,u=o.length;s<u;s++)if(i.isUrl(o[s][1])||"0"==o[s][1]){t.value=[o[s]],o.splice(s,1);break}for(s=0,u=o.length;s<u;s++)if(i.isListStylePositionKeyword(o[s][1])){r.value=[o[s]],o.splice(s,1);break}return o.length>0&&(i.isListStyleTypeKeyword(o[0][1])||i.isIdentifier(o[0][1]))&&(n.value=[o[0]]),l}function transition(e,a,i){var n,r,t,l=_wrapDefault(e.name+"-property",e,a),o=_wrapDefault(e.name+"-duration",e,a),u=_wrapDefault(e.name+"-timing-function",e,a),s=_wrapDefault(e.name+"-delay",e,a),f=[l,o,u,s],v=e.value,g=!1,d=!1,p=!1,h=!1;if(1==e.value.length&&"inherit"==e.value[0][1])return l.value=o.value=u.value=s.value=e.value,f;if(v.length>1&&_anyIsInherit(v))throw new InvalidPropertyError("Invalid animation values at "+formatPosition(v[0][2][0])+". Ignoring.");for(r=0,t=v.length;r<t;r++)if(n=v[r],i.isTime(n[1])&&!g)o.value=[n],g=!0;else if(i.isTime(n[1])&&!d)s.value=[n],d=!0;else if(!i.isGlobal(n[1])&&!i.isTimingFunction(n[1])||h){if(!i.isIdentifier(n[1])||p)throw new InvalidPropertyError("Invalid animation value at "+formatPosition(n[2][0])+". Ignoring.");l.value=[n],p=!0}else u.value=[n],h=!0;return f}function widthStyleColor(e,a,i){for(var n,r,t,l=a[e.name],o=[_wrapDefault(l.components[0],e,a),_wrapDefault(l.components[1],e,a),_wrapDefault(l.components[2],e,a)],u=0;u<3;u++){var s=o[u];s.name.indexOf("color")>0?n=s:s.name.indexOf("style")>0?r=s:t=s}if(1==e.value.length&&"inherit"==e.value[0][1]||3==e.value.length&&"inherit"==e.value[0][1]&&"inherit"==e.value[1][1]&&"inherit"==e.value[2][1])return n.value=r.value=t.value=[e.value[0]],o;var f,v,g=e.value.slice(0);return g.length>0&&(f=(v=g.filter(_widthFilter(i))).length>1&&("none"==v[0][1]||"auto"==v[0][1])?v[1]:v[0])&&(t.value=[f],g.splice(g.indexOf(f),1)),g.length>0&&(f=g.filter(_styleFilter(i))[0])&&(r.value=[f],g.splice(g.indexOf(f),1)),g.length>0&&(f=g.filter(_colorFilter(i))[0])&&(n.value=[f],g.splice(g.indexOf(f),1)),o}module.exports={animation:animation,background:background,border:widthStyleColor,borderRadius:borderRadius,font:font,fourValues:fourValues,listStyle:listStyle,multiplex:multiplex,outline:widthStyleColor,transition:transition};