var populateComponents=require("./properties/populate-components"),wrapForOptimizing=require("../wrap-for-optimizing").single,restoreFromOptimizing=require("../restore-from-optimizing"),Token=require("../../tokenizer/token"),animationNameRegex=/^(-moz-|-o-|-webkit-)?animation-name$/,animationRegex=/^(-moz-|-o-|-webkit-)?animation$/,keyframeRegex=/^@(-moz-|-o-|-webkit-)?keyframes /,importantRegex=/\s{0,31}!important$/,optionalMatchingQuotesRegex=/^(['"]?)(.*)\1$/;function normalize(e){return e.replace(optionalMatchingQuotesRegex,"$2").replace(importantRegex,"")}function removeUnusedAtRules(e,t){removeUnusedAtRule(e,matchCounterStyle,markCounterStylesAsUsed,t),removeUnusedAtRule(e,matchFontFace,markFontFacesAsUsed,t),removeUnusedAtRule(e,matchKeyframe,markKeyframesAsUsed,t),removeUnusedAtRule(e,matchNamespace,markNamespacesAsUsed,t)}function removeUnusedAtRule(e,t,n,o){var r,a,i,s,m,l={};for(s=0,m=e.length;s<m;s++)t(e[s],l);if(0!==Object.keys(l).length)for(r in markUsedAtRules(e,n,l,o),l)for(s=0,m=(a=l[r]).length;s<m;s++)(i=a[s])[i[0]==Token.AT_RULE?1:2]=[]}function markUsedAtRules(e,t,n,o){var r,a,i=t(n);for(r=0,a=e.length;r<a;r++)switch(e[r][0]){case Token.RULE:i(e[r],o);break;case Token.NESTED_BLOCK:markUsedAtRules(e[r][2],t,n,o)}}function matchCounterStyle(e,t){var n;e[0]==Token.AT_RULE_BLOCK&&0===e[1][0][1].indexOf("@counter-style")&&(t[n=e[1][0][1].split(" ")[1]]=t[n]||[],t[n].push(e))}function markCounterStylesAsUsed(e){return function(t,n){var o,r,a,i;for(a=0,i=t[2].length;a<i;a++)"list-style"==(o=t[2][a])[1][1]&&(r=wrapForOptimizing(o),populateComponents([r],n.validator,n.warnings),r.components[0].value[0][1]in e&&delete e[o[2][1]],restoreFromOptimizing([r])),"list-style-type"==o[1][1]&&o[2][1]in e&&delete e[o[2][1]]}}function matchFontFace(e,t){var n,o,r,a;if(e[0]==Token.AT_RULE_BLOCK&&"@font-face"==e[1][0][1])for(r=0,a=e[2].length;r<a;r++)if("font-family"==(n=e[2][r])[1][1]){t[o=normalize(n[2][1].toLowerCase())]=t[o]||[],t[o].push(e);break}}function markFontFacesAsUsed(e){return function(t,n){var o,r,a,i,s,m,l,u;for(s=0,m=t[2].length;s<m;s++){if("font"==(o=t[2][s])[1][1]){for(r=wrapForOptimizing(o),populateComponents([r],n.validator,n.warnings),l=0,u=(a=r.components[6]).value.length;l<u;l++)(i=normalize(a.value[l][1].toLowerCase()))in e&&delete e[i];restoreFromOptimizing([r])}if("font-family"==o[1][1])for(l=2,u=o.length;l<u;l++)(i=normalize(o[l][1].toLowerCase()))in e&&delete e[i]}}}function matchKeyframe(e,t){var n;e[0]==Token.NESTED_BLOCK&&keyframeRegex.test(e[1][0][1])&&(t[n=e[1][0][1].split(" ")[1]]=t[n]||[],t[n].push(e))}function markKeyframesAsUsed(e){return function(t,n){var o,r,a,i,s,m,l;for(i=0,s=t[2].length;i<s;i++){if(o=t[2][i],animationRegex.test(o[1][1])){for(r=wrapForOptimizing(o),populateComponents([r],n.validator,n.warnings),m=0,l=(a=r.components[7]).value.length;m<l;m++)a.value[m][1]in e&&delete e[a.value[m][1]];restoreFromOptimizing([r])}if(animationNameRegex.test(o[1][1]))for(m=2,l=o.length;m<l;m++)o[m][1]in e&&delete e[o[m][1]]}}}function matchNamespace(e,t){var n;e[0]==Token.AT_RULE&&0===e[1].indexOf("@namespace")&&(t[n=e[1].split(" ")[1]]=t[n]||[],t[n].push(e))}function markNamespacesAsUsed(e){var t=new RegExp(Object.keys(e).join("\\||")+"\\|","g");return function(n){var o,r,a,i,s,m;for(a=0,i=n[1].length;a<i;a++)for(s=0,m=(o=n[1][a][1].match(t)).length;s<m;s++)(r=o[s].substring(0,o[s].length-1))in e&&delete e[r]}}module.exports=removeUnusedAtRules;