var canReorder=require("./reorderable").canReorder,canReorderSingle=require("./reorderable").canReorderSingle,extractProperties=require("./extract-properties"),rulesOverlap=require("./rules-overlap"),serializeRules=require("../../writer/one-time").rules,OptimizationLevel=require("../../options/optimization-level").OptimizationLevel,Token=require("../../tokenizer/token");function mergeMediaQueries(e,r){for(var i=r.options.level[OptimizationLevel.Two].mergeSemantically,o=r.cache.specificity,a={},t=[],n=e.length-1;n>=0;n--){var l=e[n];if(l[0]==Token.NESTED_BLOCK){var u=serializeRules(l[1]),c=a[u];c||(c=[],a[u]=c),c.push(n)}}for(var s in a){var p=a[s];e:for(var v=p.length-1;v>0;v--){var d=p[v],f=e[d],m=p[v-1],R=e[m];r:for(var g=1;g>=-1;g-=2){for(var h=1==g,q=h?d+1:m-1,z=h?m:d,S=h?1:-1,O=h?f:R,x=h?R:f,P=extractProperties(O);q!=z;){var k=extractProperties(e[q]);if(q+=S,!(i&&allSameRulePropertiesCanBeReordered(P,k,o)||canReorder(P,k,o)))continue r}x[2]=h?O[2].concat(x[2]):x[2].concat(O[2]),O[2]=[],t.push(x);continue e}}}return t}function allSameRulePropertiesCanBeReordered(e,r,i){var o,a,t,n,l,u,c,s;for(l=0,u=e.length;l<u;l++)for(a=(o=e[l])[5],c=0,s=r.length;c<s;c++)if(n=(t=r[c])[5],rulesOverlap(a,n,!0)&&!canReorderSingle(o,t,i))return!1;return!0}module.exports=mergeMediaQueries;