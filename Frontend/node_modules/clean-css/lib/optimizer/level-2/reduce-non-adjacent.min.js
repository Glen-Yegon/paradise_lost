var isMergeable=require("./is-mergeable"),optimizeProperties=require("./properties/optimize"),cloneArray=require("../../utils/clone-array"),Token=require("../../tokenizer/token"),serializeBody=require("../../writer/one-time").body,serializeRules=require("../../writer/one-time").rules;function reduceNonAdjacent(e,r){for(var i=r.options,t=i.compatibility.selectors.mergeablePseudoClasses,o=i.compatibility.selectors.mergeablePseudoElements,l=i.compatibility.selectors.multiplePseudoMerging,a={},n=[],s=e.length-1;s>=0;s--){var c=e[s];if(c[0]==Token.RULE&&0!==c[2].length)for(var u=serializeRules(c[1]),d=c[1].length>1&&isMergeable(u,t,o,l),p=wrappedSelectorsFrom(c[1]),m=d?[u].concat(p):[u],f=0,g=m.length;f<g;f++){var h=m[f];a[h]?n.push(h):a[h]=[],a[h].push({where:s,list:p,isPartial:d&&f>0,isComplex:d&&0===f})}}reduceSimpleNonAdjacentCases(e,n,a,i,r),reduceComplexNonAdjacentCases(e,a,i,r)}function wrappedSelectorsFrom(e){for(var r=[],i=0;i<e.length;i++)r.push([e[i][1]]);return r}function reduceSimpleNonAdjacentCases(e,r,i,t,o){function l(e,r){return c[e].isPartial&&0===r.length}function a(e,r,i,t){c[i-t-1].isPartial||(e[2]=r)}for(var n=0,s=r.length;n<s;n++){var c=i[r[n]];reduceSelector(e,c,{filterOut:l,callback:a},t,o)}}function reduceComplexNonAdjacentCases(e,r,i,t){var o=i.compatibility.selectors.mergeablePseudoClasses,l=i.compatibility.selectors.mergeablePseudoElements,a=i.compatibility.selectors.multiplePseudoMerging,n={};function s(e){return n.data[e].where<n.intoPosition}function c(e,r,i,t){0===t&&n.reducedBodies.push(r)}e:for(var u in r){var d=r[u];if(d[0].isComplex){var p=d[d.length-1].where,m=e[p],f=[],g=isMergeable(u,o,l,a)?d[0].list:[u];n.intoPosition=p,n.reducedBodies=f;for(var h=0,b=g.length;h<b;h++){var v=r[g[h]];if(v.length<2)continue e;if(n.data=v,reduceSelector(e,v,{filterOut:s,callback:c},i,t),serializeBody(f[f.length-1])!=serializeBody(f[0]))continue e}m[2]=f[0]}}}function reduceSelector(e,r,i,t,o){for(var l=[],a=[],n=[],s=r.length-1;s>=0;s--)if(!i.filterOut(s,l)){var c=r[s].where,u=e[c],d=cloneArray(u[2]);l=l.concat(d),a.push(d),n.push(c)}optimizeProperties(l,!0,!1,o);for(var p=n.length,m=l.length-1,f=p-1;f>=0;)if((0===f||l[m]&&a[f].indexOf(l[m])>-1)&&m>-1)m--;else{var g=l.splice(m+1);i.callback(e[n[f]],g,p,f),f--}}module.exports=reduceNonAdjacent;