var everyValuesPair=require("./every-values-pair"),hasInherit=require("./has-inherit"),hasSameValues=require("./has-same-values"),populateComponents=require("./populate-components"),configuration=require("../../configuration"),deepClone=require("../../clone").deep,restoreWithComponents=require("../restore-with-components"),restoreFromOptimizing=require("../../restore-from-optimizing"),wrapSingle=require("../../wrap-for-optimizing").single,serializeBody=require("../../../writer/one-time").body,Token=require("../../../tokenizer/token");function mergeIntoShorthands(e,n){var o,t,r,i,a,l,p,u={};if(!(e.length<3)){for(i=0,a=e.length;i<a;i++)if(r=e[i],o=configuration[r.name],!r.dynamic&&!r.unused&&!r.hack&&!r.block&&(!o||!o.singleTypeComponents||hasSameValues(r))&&(invalidateOrCompact(e,i,u,n),o&&o.componentOf))for(l=0,p=o.componentOf.length;l<p;l++)u[t=o.componentOf[l]]=u[t]||{},u[t][r.name]=r;invalidateOrCompact(e,i,u,n)}}function invalidateOrCompact(e,n,o,t){var r,i,a,l,p=e[n],u=[];for(r in o)void 0!==p&&r==p.name||(i=configuration[r],a=o[r],p&&invalidates(o,r,p)?delete o[r]:i.components.length>Object.keys(a).length||mixedImportance(a)||overridable(a,r,t)&&mergeable(a)&&(mixedInherit(a)?replaceWithInheritBestFit(e,a,r,t):replaceWithShorthand(e,a,r,t),u.push(r)));for(l=u.length-1;l>=0;l--)delete o[u[l]]}function invalidates(e,n,o){var t,r=configuration[n],i=configuration[o.name];if("overridesShorthands"in r&&r.overridesShorthands.indexOf(o.name)>-1)return!0;if(i&&"componentOf"in i)for(t in e[n])if(i.componentOf.indexOf(t)>-1)return!0;return!1}function mixedImportance(e){var n,o;for(o in e){if(void 0!==n&&e[o].important!=n)return!0;n=e[o].important}return!1}function overridable(e,n,o){var t,r,i,a,l=configuration[n],p=[Token.PROPERTY,[Token.PROPERTY_NAME,n],[Token.PROPERTY_VALUE,l.defaultValue]],u=wrapSingle(p);for(populateComponents([u],o,[]),i=0,a=l.components.length;i<a;i++)if(t=e[l.components[i]],r=configuration[t.name].canOverride||sameValue,!everyValuesPair(r.bind(null,o),u.components[i],t))return!1;return!0}function sameValue(e,n,o){return n===o}function mergeable(e){var n,o,t,r,i=null;for(o in e)if(t=e[o],"restore"in(r=configuration[o])){if(restoreFromOptimizing([t.all[t.position]],restoreWithComponents),n=r.restore(t,configuration).length,null!==i&&n!==i)return!1;i=n}return!0}function mixedInherit(e){var n,o,t=null;for(n in e){if(o=hasInherit(e[n]),null!==t&&t!==o)return!0;t=o}return!1}function replaceWithInheritBestFit(e,n,o,t){var r,i,a,l,p=buildSequenceWithInheritLonghands(n,o,t),u=buildSequenceWithInheritShorthand(n,o,t),s=p[0],m=u[0],h=serializeBody(s).length<serializeBody(m).length,f=h?s:m,c=h?p[1]:u[1],d=h?p[2]:u[2],g=n[Object.keys(n).pop()],v=g.all,T=g.position;for(r in c.position=T,c.shorthand=!0,c.important=g.important,c.multiplex=!1,c.dirty=!0,c.all=v,c.all[T]=f[0],e.splice(T,1,c),n)(i=n[r]).unused=!0,c.multiplex=c.multiplex||i.multiplex,i.name in d&&(a=d[i.name],l=findTokenIn(f,r),a.position=v.length,a.all=v,a.all.push(l),e.push(a))}function buildSequenceWithInheritLonghands(e,n,o){var t,r,i,a,l,p,u=[],s={},m={},h=configuration[n],f=[Token.PROPERTY,[Token.PROPERTY_NAME,n],[Token.PROPERTY_VALUE,h.defaultValue]],c=wrapSingle(f);for(populateComponents([c],o,[]),l=0,p=h.components.length;l<p;l++)t=e[h.components[l]],hasInherit(t)?(r=t.all[t.position].slice(0,2),Array.prototype.push.apply(r,t.value),u.push(r),(i=deepClone(t)).value=inferComponentValue(e,i.name),c.components[l]=i,s[t.name]=deepClone(t)):((i=deepClone(t)).all=t.all,c.components[l]=i,m[t.name]=t);return c.important=e[Object.keys(e).pop()].important,a=joinMetadata(m,1),f[1].push(a),restoreFromOptimizing([c],restoreWithComponents),f=f.slice(0,2),Array.prototype.push.apply(f,c.value),u.unshift(f),[u,c,s]}function inferComponentValue(e,n){var o=configuration[n];return"oppositeTo"in o?e[o.oppositeTo].value:[[Token.PROPERTY_VALUE,o.defaultValue]]}function joinMetadata(e,n){var o,t,r,i,a=[];for(i in e)r=(t=(o=e[i]).all[o.position])[n][t[n].length-1],Array.prototype.push.apply(a,r);return a.sort(metadataSorter)}function metadataSorter(e,n){var o=e[0],t=n[0],r=e[1],i=n[1];return o<t||o===t&&r<i?-1:1}function buildSequenceWithInheritShorthand(e,n,o){var t,r,i,a,l,p,u=[],s={},m={},h=configuration[n],f=[Token.PROPERTY,[Token.PROPERTY_NAME,n],[Token.PROPERTY_VALUE,"inherit"]],c=wrapSingle(f);for(populateComponents([c],o,[]),l=0,p=h.components.length;l<p;l++)t=e[h.components[l]],hasInherit(t)?s[t.name]=t:(r=t.all[t.position].slice(0,2),Array.prototype.push.apply(r,t.value),u.push(r),m[t.name]=deepClone(t));return i=joinMetadata(s,1),f[1].push(i),a=joinMetadata(s,2),f[2].push(a),u.unshift(f),[u,c,m]}function findTokenIn(e,n){var o,t;for(o=0,t=e.length;o<t;o++)if(e[o][1][1]==n)return e[o]}function replaceWithShorthand(e,n,o,t){var r,i,a,l=configuration[o],p=[Token.PROPERTY,[Token.PROPERTY_NAME,o],[Token.PROPERTY_VALUE,l.defaultValue]],u=inferInsertAtFrom(e,n,o),s=wrapSingle(p);s.shorthand=!0,s.dirty=!0,s.multiplex=!1,populateComponents([s],t,[]);for(var m=0,h=l.components.length;m<h;m++){var f=n[l.components[m]];s.components[m]=deepClone(f),s.important=f.important,s.multiplex=s.multiplex||f.multiplex,a=f.all}for(var c in n)n[c].unused=!0;r=joinMetadata(n,1),p[1].push(r),i=joinMetadata(n,2),p[2].push(i),s.position=u,s.all=a,s.all[u]=p,e.splice(u,1,s)}function inferInsertAtFrom(e,n,o){var t=Object.keys(n),r=n[t[0]].position,i=n[t[t.length-1]].position;return"border"==o&&traversesVia(e.slice(r,i),"border-image")?r:i}function traversesVia(e,n){for(var o=e.length-1;o>=0;o--)if(e[o].name==n)return!0;return!1}module.exports=mergeIntoShorthands;