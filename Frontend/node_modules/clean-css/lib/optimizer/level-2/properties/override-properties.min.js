var hasInherit=require("./has-inherit"),hasUnset=require("./has-unset"),everyValuesPair=require("./every-values-pair"),findComponentIn=require("./find-component-in"),isComponentOf=require("./is-component-of"),isMergeableShorthand=require("./is-mergeable-shorthand"),overridesNonComponentShorthand=require("./overrides-non-component-shorthand"),sameVendorPrefixesIn=require("./../../vendor-prefixes").same,configuration=require("../../configuration"),deepClone=require("../../clone").deep,restoreWithComponents=require("../restore-with-components"),shallowClone=require("../../clone").shallow,restoreFromOptimizing=require("../../restore-from-optimizing"),Token=require("../../../tokenizer/token"),Marker=require("../../../tokenizer/marker"),serializeProperty=require("../../../writer/one-time").property;function sameValue(e,n,i){return n===i}function wouldBreakCompatibility(e,n){for(var i=0;i<e.components.length;i++){var r=e.components[i],o=configuration[r.name],t=o&&o.canOverride||sameValue,a=shallowClone(r);if(a.value=[[Token.PROPERTY_VALUE,o.defaultValue]],!everyValuesPair(t.bind(null,n),a,r))return!0}return!1}function overrideIntoMultiplex(e,n){n.unused=!0,turnIntoMultiplex(n,multiplexSize(e)),e.value=n.value}function overrideByMultiplex(e,n){n.unused=!0,e.multiplex=!0,e.value=n.value}function overrideSimple(e,n){n.unused=!0,e.value=n.value}function override(e,n){n.multiplex?overrideByMultiplex(e,n):e.multiplex?overrideIntoMultiplex(e,n):overrideSimple(e,n)}function overrideShorthand(e,n){n.unused=!0;for(var i=0,r=e.components.length;i<r;i++)override(e.components[i],n.components[i])}function turnIntoMultiplex(e,n){e.multiplex=!0,configuration[e.name].shorthand?turnShorthandValueIntoMultiplex(e,n):turnLonghandValueIntoMultiplex(e,n)}function turnShorthandValueIntoMultiplex(e,n){var i,r,o;for(r=0,o=e.components.length;r<o;r++)(i=e.components[r]).multiplex||turnLonghandValueIntoMultiplex(i,n)}function turnLonghandValueIntoMultiplex(e,n){for(var i,r=configuration[e.name],o="real"==r.intoMultiplexMode,t="real"==r.intoMultiplexMode?e.value.slice(0):"placeholder"==r.intoMultiplexMode?r.placeholderValue:r.defaultValue,a=multiplexSize(e),u=t.length;a<n;a++)if(e.value.push([Token.PROPERTY_VALUE,Marker.COMMA]),Array.isArray(t))for(i=0;i<u;i++)e.value.push(o?t[i]:[Token.PROPERTY_VALUE,t[i]]);else e.value.push(o?t:[Token.PROPERTY_VALUE,t])}function multiplexSize(e){for(var n=0,i=0,r=e.value.length;i<r;i++)e.value[i][1]==Marker.COMMA&&n++;return n+1}function lengthOf(e){var n=[Token.PROPERTY,[Token.PROPERTY_NAME,e.name]].concat(e.value);return serializeProperty([n],0).length}function moreSameShorthands(e,n,i){for(var r=0,o=n;o>=0&&(e[o].name!=i||e[o].unused||r++,!(r>1));o--);return r>1}function overridingFunction(e,n){for(var i=0,r=e.components.length;i<r;i++)if(!anyValue(n.isUrl,e.components[i])&&anyValue(n.isFunction,e.components[i]))return!0;return!1}function anyValue(e,n){for(var i=0,r=n.value.length;i<r;i++)if(n.value[i][1]!=Marker.COMMA&&e(n.value[i][1]))return!0;return!1}function wouldResultInLongerValue(e,n){if(!e.multiplex&&!n.multiplex||e.multiplex&&n.multiplex)return!1;var i,r=e.multiplex?e:n,o=e.multiplex?n:e,t=deepClone(r);restoreFromOptimizing([t],restoreWithComponents);var a=deepClone(o);restoreFromOptimizing([a],restoreWithComponents);var u=lengthOf(t)+1+lengthOf(a);return e.multiplex?overrideIntoMultiplex(i=findComponentIn(t,a),a):(i=findComponentIn(a,t),turnIntoMultiplex(a,multiplexSize(t)),overrideByMultiplex(i,t)),restoreFromOptimizing([a],restoreWithComponents),u<=lengthOf(a)}function isCompactable(e){return e.name in configuration}function noneOverrideHack(e,n){return!e.multiplex&&("background"==e.name||"background-image"==e.name)&&n.multiplex&&("background"==n.name||"background-image"==n.name)&&anyLayerIsNone(n.value)}function anyLayerIsNone(e){for(var n=intoLayers(e),i=0,r=n.length;i<r;i++)if(1==n[i].length&&"none"==n[i][0][1])return!0;return!1}function intoLayers(e){for(var n=[],i=0,r=[],o=e.length;i<o;i++){var t=e[i];t[1]==Marker.COMMA?(n.push(r),r=[]):r.push(t)}return n.push(r),n}function overrideProperties(e,n,i,r){var o,t,a,u,l,s,m,p,c,d,f;e:for(c=e.length-1;c>=0;c--)if(isCompactable(t=e[c])&&!t.block){o=configuration[t.name].canOverride||sameValue;n:for(d=c-1;d>=0;d--)if(isCompactable(a=e[d])&&!a.block&&!a.dynamic&&!t.dynamic&&!a.unused&&!t.unused&&(!a.hack||t.hack||t.important)&&(a.hack||a.important||!t.hack)&&(a.important!=t.important||a.hack[0]==t.hack[0])&&!(a.important==t.important&&(a.hack[0]!=t.hack[0]||a.hack[1]&&a.hack[1]!=t.hack[1])||hasInherit(t)||noneOverrideHack(a,t)))if(t.shorthand&&isComponentOf(t,a)){if(!t.important&&a.important)continue;if(!sameVendorPrefixesIn([a],t.components))continue;if(!anyValue(r.isFunction,a)&&overridingFunction(t,r))continue;if(!isMergeableShorthand(t)){a.unused=!0;continue}u=findComponentIn(t,a),o=configuration[a.name].canOverride||sameValue,everyValuesPair(o.bind(null,r),a,u)&&(a.unused=!0)}else if(t.shorthand&&overridesNonComponentShorthand(t,a)){if(!t.important&&a.important)continue;if(!sameVendorPrefixesIn([a],t.components))continue;if(!anyValue(r.isFunction,a)&&overridingFunction(t,r))continue;for(f=(l=a.shorthand?a.components:[a]).length-1;f>=0;f--)if(s=l[f],m=findComponentIn(t,s),o=configuration[s.name].canOverride||sameValue,!everyValuesPair(o.bind(null,r),a,m))continue n;a.unused=!0}else if(n&&a.shorthand&&!t.shorthand&&isComponentOf(a,t,!0)){if(t.important&&!a.important)continue;if(!t.important&&a.important){t.unused=!0;continue}if(moreSameShorthands(e,c-1,a.name))continue;if(overridingFunction(a,r))continue;if(!isMergeableShorthand(a))continue;if(hasUnset(a)||hasUnset(t))continue;if(u=findComponentIn(a,t),everyValuesPair(o.bind(null,r),u,t)){var h=!i.properties.backgroundClipMerging&&u.name.indexOf("background-clip")>-1||!i.properties.backgroundOriginMerging&&u.name.indexOf("background-origin")>-1||!i.properties.backgroundSizeMerging&&u.name.indexOf("background-size")>-1,v=configuration[t.name].nonMergeableValue===t.value[0][1];if(h||v)continue;if(!i.properties.merging&&wouldBreakCompatibility(a,r))continue;if(u.value[0][1]!=t.value[0][1]&&(hasInherit(a)||hasInherit(t)))continue;if(wouldResultInLongerValue(a,t))continue;!a.multiplex&&t.multiplex&&turnIntoMultiplex(a,multiplexSize(t)),override(u,t),a.dirty=!0}}else if(n&&a.shorthand&&t.shorthand&&a.name==t.name){if(!a.multiplex&&t.multiplex)continue;if(!t.important&&a.important){t.unused=!0;continue e}if(t.important&&!a.important){a.unused=!0;continue}if(!isMergeableShorthand(t)){a.unused=!0;continue}for(f=a.components.length-1;f>=0;f--){var g=a.components[f],x=t.components[f];if(o=configuration[g.name].canOverride||sameValue,!everyValuesPair(o.bind(null,r),g,x))continue e}overrideShorthand(a,t),a.dirty=!0}else if(n&&a.shorthand&&t.shorthand&&isComponentOf(a,t)){if(!a.important&&t.important)continue;if(u=findComponentIn(a,t),o=configuration[t.name].canOverride||sameValue,!everyValuesPair(o.bind(null,r),u,t))continue;if(a.important&&!t.important){t.unused=!0;continue}if(configuration[t.name].restore(t,configuration).length>1)continue;override(u=findComponentIn(a,t),t),t.dirty=!0}else if(a.name==t.name){if(p=!0,t.shorthand)for(f=t.components.length-1;f>=0&&p;f--)s=a.components[f],m=t.components[f],o=configuration[m.name].canOverride||sameValue,p=everyValuesPair(o.bind(null,r),s,m);else o=configuration[t.name].canOverride||sameValue,p=everyValuesPair(o.bind(null,r),a,t);if(a.important&&!t.important&&p){t.unused=!0;continue}if(!a.important&&t.important&&p){a.unused=!0;continue}if(!p)continue;a.unused=!0}}}module.exports=overrideProperties;