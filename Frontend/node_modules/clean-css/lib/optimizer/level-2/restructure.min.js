var canReorderSingle=require("./reorderable").canReorderSingle,extractProperties=require("./extract-properties"),isMergeable=require("./is-mergeable"),tidyRuleDuplicates=require("./tidy-rule-duplicates"),Token=require("../../tokenizer/token"),cloneArray=require("../../utils/clone-array"),serializeBody=require("../../writer/one-time").body,serializeRules=require("../../writer/one-time").rules;function naturalSorter(e,r){return e>r?1:-1}function cloneAndMergeSelectors(e,r){var n=cloneArray(e);return n[5]=n[5].concat(r[5]),n}function restructure(e,r){var n=r.options,t=n.compatibility.selectors.mergeablePseudoClasses,i=n.compatibility.selectors.mergeablePseudoElements,l=n.compatibility.selectors.mergeLimit,o=n.compatibility.selectors.multiplePseudoMerging,a=r.cache.specificity,u={},f=[],s={},c=[],h="%";function g(e,r){var n=function(e){for(var r=[],n=0,t=e.length;n<t;n++)r.push(serializeRules(e[n][1]));return r.join(h)}(r);return s[n]=s[n]||[],s[n].push([e,r]),n}function v(e){var r,n=e.split(h),t=[];for(var i in s){var l=i.split(h);for(r=l.length-1;r>=0;r--)if(n.indexOf(l[r])>-1){t.push(i);break}}for(r=t.length-1;r>=0;r--)delete s[t[r]]}function p(e){for(var r=[],n=[],l=e.length-1;l>=0;l--)isMergeable(serializeRules(e[l][1]),t,i,o)&&(n.unshift(e[l]),e[l][2].length>0&&-1==r.indexOf(e[l])&&r.push(e[l]));return r.length>1?n:[]}function d(e,r){var n=r[0],t=r[1],i=r[4],l=n.length+t.length+1,o=[],a=[],f=p(u[i]);if(!(f.length<2)){var c=y(f,l,1),h=c[0];if(h[1]>0)return function(e,r,n){for(var t=n.length-1;t>=0;t--){var i=g(r,n[t][0]);if(s[i].length>1&&O(e,s[i])){v(i);break}}}(e,r,c);for(var d=h[0].length-1;d>=0;d--)o=h[0][d][1].concat(o),a.unshift(h[0][d]);x(e,[r],o=tidyRuleDuplicates(o),a)}}function b(e,r){return e[1]>r[1]?1:e[1]==r[1]?0:-1}function y(e,r,n){return k(e,r,n,1).sort(b)}function k(e,r,n,t){var i=[[e,m(e,r,n)]];if(e.length>2&&t>0)for(var l=e.length-1;l>=0;l--){var o=Array.prototype.slice.call(e,0);o.splice(l,1),i=i.concat(k(o,r,n,t-1))}return i}function m(e,r,n){for(var t=0,i=e.length-1;i>=0;i--)t+=e[i][2].length>n?serializeRules(e[i][1]).length:-1;return t-(e.length-1)*r+1}function x(r,n,t,i){var l,o,a,u,f=[];for(l=i.length-1;l>=0;l--){var s=i[l];for(o=s[2].length-1;o>=0;o--){var c=s[2][o];for(a=0,u=n.length;a<u;a++){var h=n[a],g=c[1][1],v=h[0],p=h[4];if(g==v&&serializeBody([c])==p){s[2].splice(o,1);break}}}}for(l=n.length-1;l>=0;l--)f.unshift(n[l][3]);var d=[Token.RULE,t,f];e.splice(r,0,d)}function R(e,r){var n=r[4],t=u[n];t&&t.length>1&&(function(e,r){var n,t,i=[],l=[],o=r[4],a=p(u[o]);if(a.length<2)return;e:for(var s in u){var c=u[s];for(n=a.length-1;n>=0;n--)if(-1==c.indexOf(a[n]))continue e;i.push(s)}if(i.length<2)return!1;for(n=i.length-1;n>=0;n--)for(t=f.length-1;t>=0;t--)if(f[t][4]==i[n]){l.unshift([f[t],a]);break}return O(e,l)}(e,r)||d(e,r))}function O(e,r){for(var n,t=0,i=[],l=r.length-1;l>=0;l--){t+=(n=r[l][0])[4].length+(l>0?1:0),i.push(n)}var o=y(r[0][1],t,i.length)[0];if(o[1]>0)return!1;var a=[],s=[];for(l=o[0].length-1;l>=0;l--)a=o[0][l][1].concat(a),s.unshift(o[0][l]);for(x(e,i,a=tidyRuleDuplicates(a),s),l=i.length-1;l>=0;l--){n=i[l];var h=f.indexOf(n);delete u[n[4]],h>-1&&-1==c.indexOf(h)&&c.push(h)}return!0}function T(e,r,n){if(e[0]!=r[0])return!1;var t=r[4],i=u[t];return i&&i.indexOf(n)>-1}for(var S=e.length-1;S>=0;S--){var q,E,z,A,M,L=e[S];if(L[0]==Token.RULE)q=!0;else{if(L[0]!=Token.NESTED_BLOCK)continue;q=!1}var P=f.length,D=extractProperties(L);c=[];var U=[];for(E=D.length-1;E>=0;E--)for(z=E-1;z>=0;z--)if(!canReorderSingle(D[E],D[z],a)){U.push(E);break}for(E=D.length-1;E>=0;E--){var B=D[E],C=!1;for(z=0;z<P;z++){var _=f[z];-1==c.indexOf(z)&&(!canReorderSingle(B,_,a)&&!T(B,_,L)||u[_[4]]&&u[_[4]].length===l)&&(R(S+1,_),-1==c.indexOf(z)&&(c.push(z),delete u[_[4]])),C||(C=B[0]==_[0]&&B[1]==_[1])&&(M=z)}if(q&&!(U.indexOf(E)>-1)){var w=B[4];C&&f[M][5].length+B[5].length>l?(R(S+1,f[M]),f.splice(M,1),u[w]=[L],C=!1):(u[w]=u[w]||[],u[w].push(L)),C?f[M]=cloneAndMergeSelectors(f[M],B):f.push(B)}}for(E=0,A=(c=c.sort(naturalSorter)).length;E<A;E++){var N=c[E]-E;f.splice(N,1)}}for(var j=e[0]&&e[0][0]==Token.AT_RULE&&0===e[0][1].indexOf("@charset")?1:0;j<e.length-1;j++){var K=e[j][0]===Token.AT_RULE&&0===e[j][1].indexOf("@import"),F=e[j][0]===Token.COMMENT;if(!K&&!F)break}for(S=0;S<f.length;S++)R(j,f[S])}module.exports=restructure;