var Marker=require("../../tokenizer/marker"),split=require("../../utils/split"),DEEP_SELECTOR_PATTERN=/\/deep\//,DOUBLE_COLON_PATTERN=/^::/,VENDOR_PREFIXED_PATTERN=/:(-moz-|-ms-|-o-|-webkit-)/,NOT_PSEUDO=":not",PSEUDO_CLASSES_WITH_ARGUMENTS=[":dir",":lang",":not",":nth-child",":nth-last-child",":nth-last-of-type",":nth-of-type"],RELATION_PATTERN=/[>+~]/,UNMIXABLE_PSEUDO_CLASSES=[":after",":before",":first-letter",":first-line",":lang"],UNMIXABLE_PSEUDO_ELEMENTS=["::after","::before","::first-letter","::first-line"],Level={DOUBLE_QUOTE:"double-quote",SINGLE_QUOTE:"single-quote",ROOT:"root"};function isMergeable(e,r,E,O){var n,t,i,_=split(e,Marker.COMMA);for(t=0,i=_.length;t<i;t++)if(0===(n=_[t]).length||isDeepSelector(n)||isVendorPrefixed(n)||n.indexOf(Marker.COLON)>-1&&!areMergeable(n,extractPseudoFrom(n),r,E,O))return!1;return!0}function isDeepSelector(e){return DEEP_SELECTOR_PATTERN.test(e)}function isVendorPrefixed(e){return VENDOR_PREFIXED_PATTERN.test(e)}function extractPseudoFrom(e){var r,E,O,n,t,i,_=[],l=[],u=Level.ROOT,T=0,s=!1,N=!1;for(t=0,i=e.length;t<i;t++)r=e[t],n=!O&&RELATION_PATTERN.test(r),E=u==Level.DOUBLE_QUOTE||u==Level.SINGLE_QUOTE,O?l.push(r):r==Marker.DOUBLE_QUOTE&&u==Level.ROOT?(l.push(r),u=Level.DOUBLE_QUOTE):r==Marker.DOUBLE_QUOTE&&u==Level.DOUBLE_QUOTE?(l.push(r),u=Level.ROOT):r==Marker.SINGLE_QUOTE&&u==Level.ROOT?(l.push(r),u=Level.SINGLE_QUOTE):r==Marker.SINGLE_QUOTE&&u==Level.SINGLE_QUOTE?(l.push(r),u=Level.ROOT):E?l.push(r):r==Marker.OPEN_ROUND_BRACKET?(l.push(r),T++):r==Marker.CLOSE_ROUND_BRACKET&&1==T&&s?(l.push(r),_.push(l.join("")),T--,l=[],s=!1):r==Marker.CLOSE_ROUND_BRACKET?(l.push(r),T--):r==Marker.COLON&&0===T&&s&&!N?(_.push(l.join("")),(l=[]).push(r)):r!=Marker.COLON||0!==T||N?r==Marker.SPACE&&0===T&&s||n&&0===T&&s?(_.push(l.join("")),l=[],s=!1):l.push(r):((l=[]).push(r),s=!0),O=r==Marker.BACK_SLASH,N=r==Marker.COLON;return l.length>0&&s&&_.push(l.join("")),_}function areMergeable(e,r,E,O,n){return areAllowed(r,E,O)&&needArguments(r)&&(r.length<2||!someIncorrectlyChained(e,r))&&(r.length<2||n&&allMixable(r))}function areAllowed(e,r,E){var O,n,t,i;for(t=0,i=e.length;t<i;t++)if(n=(O=e[t]).indexOf(Marker.OPEN_ROUND_BRACKET)>-1?O.substring(0,O.indexOf(Marker.OPEN_ROUND_BRACKET)):O,-1===r.indexOf(n)&&-1===E.indexOf(n))return!1;return!0}function needArguments(e){var r,E,O,n,t,i;for(t=0,i=e.length;t<i;t++){if(E=(n=(O=(r=e[t]).indexOf(Marker.OPEN_ROUND_BRACKET))>-1)?r.substring(0,O):r,n&&-1==PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(E))return!1;if(!n&&PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(E)>-1)return!1}return!0}function someIncorrectlyChained(e,r){var E,O,n,t,i,_,l,u,T=0;for(l=0,u=r.length;l<u&&(E=r[l],n=r[l+1]);l++)if(O=e.indexOf(E,T),T=t=e.indexOf(E,O+1),O+E.length==t&&(i=E.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?E.substring(0,E.indexOf(Marker.OPEN_ROUND_BRACKET)):E,_=n.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?n.substring(0,n.indexOf(Marker.OPEN_ROUND_BRACKET)):n,i!=NOT_PSEUDO||_!=NOT_PSEUDO))return!0;return!1}function allMixable(e){var r,E,O,n=0;for(E=0,O=e.length;E<O;E++)if(isPseudoElement(r=e[E])?n+=UNMIXABLE_PSEUDO_ELEMENTS.indexOf(r)>-1?1:0:n+=UNMIXABLE_PSEUDO_CLASSES.indexOf(r)>-1?1:0,n>1)return!1;return!0}function isPseudoElement(e){return DOUBLE_COLON_PATTERN.test(e)}module.exports=isMergeable;