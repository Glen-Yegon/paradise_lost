var Hack=require("./hack"),Marker=require("../tokenizer/marker"),Token=require("../tokenizer/token"),Match={ASTERISK:"*",BACKSLASH:"\\",BANG:"!",BANG_SUFFIX_PATTERN:/!\w+$/,IMPORTANT_TOKEN:"!important",IMPORTANT_TOKEN_PATTERN:new RegExp("!important$","i"),IMPORTANT_WORD:"important",IMPORTANT_WORD_PATTERN:new RegExp("important$","i"),SUFFIX_BANG_PATTERN:/!$/,UNDERSCORE:"_",VARIABLE_REFERENCE_PATTERN:/var\(--.+\)$/};function wrapAll(t,e){var n,r,a,A=[];for(a=t.length-1;a>=0;a--)(r=t[a])[0]==Token.PROPERTY&&(e&&e.indexOf(r[1][1])>-1||((n=wrapSingle(r)).all=t,n.position=a,A.unshift(n)));return A}function someVariableReferences(t){var e,n,r;for(e=2,n=t.length;e<n;e++)if((r=t[e])[0]==Token.PROPERTY_VALUE&&isVariableReference(r[1]))return!0;return!1}function isVariableReference(t){return Match.VARIABLE_REFERENCE_PATTERN.test(t)}function isMultiplex(t){var e,n,r;for(n=3,r=t.length;n<r;n++)if((e=t[n])[0]==Token.PROPERTY_VALUE&&(e[1]==Marker.COMMA||e[1]==Marker.FORWARD_SLASH))return!0;return!1}function hackFrom(t){var e=!1,n=t[1][1],r=t[t.length-1];return n[0]==Match.UNDERSCORE?e=[Hack.UNDERSCORE]:n[0]==Match.ASTERISK?e=[Hack.ASTERISK]:r[1][0]!=Match.BANG||r[1].match(Match.IMPORTANT_WORD_PATTERN)?r[1].indexOf(Match.BANG)>0&&!r[1].match(Match.IMPORTANT_WORD_PATTERN)&&Match.BANG_SUFFIX_PATTERN.test(r[1])?e=[Hack.BANG]:r[1].indexOf(Match.BACKSLASH)>0&&r[1].indexOf(Match.BACKSLASH)==r[1].length-Match.BACKSLASH.length-1?e=[Hack.BACKSLASH,r[1].substring(r[1].indexOf(Match.BACKSLASH)+1)]:0===r[1].indexOf(Match.BACKSLASH)&&2==r[1].length&&(e=[Hack.BACKSLASH,r[1].substring(1)]):e=[Hack.BANG],e}function isImportant(t){if(t.length<3)return!1;var e=t[t.length-1];return!!Match.IMPORTANT_TOKEN_PATTERN.test(e[1])||!(!Match.IMPORTANT_WORD_PATTERN.test(e[1])||!Match.SUFFIX_BANG_PATTERN.test(t[t.length-2][1]))}function stripImportant(t){var e=t[t.length-1],n=t[t.length-2];Match.IMPORTANT_TOKEN_PATTERN.test(e[1])?e[1]=e[1].replace(Match.IMPORTANT_TOKEN_PATTERN,""):(e[1]=e[1].replace(Match.IMPORTANT_WORD_PATTERN,""),n[1]=n[1].replace(Match.SUFFIX_BANG_PATTERN,"")),0===e[1].length&&t.pop(),0===n[1].length&&t.pop()}function stripPrefixHack(t){t[1][1]=t[1][1].substring(1)}function stripSuffixHack(t,e){var n=t[t.length-1];n[1]=n[1].substring(0,n[1].indexOf(e[0]==Hack.BACKSLASH?Match.BACKSLASH:Match.BANG)).trim(),0===n[1].length&&t.pop()}function wrapSingle(t){var e=isImportant(t);e&&stripImportant(t);var n=hackFrom(t);return n[0]==Hack.ASTERISK||n[0]==Hack.UNDERSCORE?stripPrefixHack(t):n[0]!=Hack.BACKSLASH&&n[0]!=Hack.BANG||stripSuffixHack(t,n),{block:t[2]&&t[2][0]==Token.PROPERTY_BLOCK,components:[],dirty:!1,dynamic:someVariableReferences(t),hack:n,important:e,name:t[1][1],multiplex:t.length>3&&isMultiplex(t),optimizable:!0,position:0,shorthand:!1,unused:!1,value:t.slice(2)}}module.exports={all:wrapAll,single:wrapSingle};