var extractImportUrlAndMedia=require("./extract-import-url-and-media"),restoreImport=require("./restore-import"),rewriteUrl=require("./rewrite-url"),Token=require("../tokenizer/token"),isImport=require("../utils/is-import"),SOURCE_MAP_COMMENT_PATTERN=/^\/\*# sourceMappingURL=(\S+) \*\/$/;function rebase(e,r,t,a){return r?rebaseEverything(e,t,a):rebaseAtRules(e,t,a)}function rebaseEverything(e,r,t){var a,o,i;for(o=0,i=e.length;o<i;o++)switch((a=e[o])[0]){case Token.AT_RULE:rebaseAtRule(a,r,t);break;case Token.AT_RULE_BLOCK:rebaseProperties(a[2],r,t);break;case Token.COMMENT:rebaseSourceMapComment(a,t);break;case Token.NESTED_BLOCK:rebaseEverything(a[2],r,t);break;case Token.RULE:rebaseProperties(a[2],r,t)}return e}function rebaseAtRules(e,r,t){var a,o,i;for(o=0,i=e.length;o<i;o++)if((a=e[o])[0]===Token.AT_RULE)rebaseAtRule(a,r,t);return e}function rebaseAtRule(e,r,t){if(isImport(e[1])){var a=extractImportUrlAndMedia(e[1]),o=rewriteUrl(a[0],t),i=a[1];e[1]=restoreImport(o,i)}}function rebaseSourceMapComment(e,r){var t=SOURCE_MAP_COMMENT_PATTERN.exec(e[1]);t&&-1===t[1].indexOf("data:")&&(e[1]=e[1].replace(t[1],rewriteUrl(t[1],r,!0)))}function rebaseProperties(e,r,t){var a,o,i,n,s,u;for(i=0,n=e.length;i<n;i++)for(s=2,u=(a=e[i]).length;s<u;s++)o=a[s][1],r.isUrl(o)&&(a[s][1]=rewriteUrl(o,t))}module.exports=rebase;