var path=require("path"),url=require("url"),isDataUriResource=require("../utils/is-data-uri-resource"),DOUBLE_QUOTE='"',SINGLE_QUOTE="'",URL_PREFIX="url(",URL_SUFFIX=")",PROTOCOL_LESS_PREFIX_PATTERN=/^[^\w\d]*\/\//,QUOTE_PREFIX_PATTERN=/^["']/,QUOTE_SUFFIX_PATTERN=/["']$/,ROUND_BRACKETS_PATTERN=/[()]/,URL_PREFIX_PATTERN=/^url\(/i,URL_SUFFIX_PATTERN=/\)$/,WHITESPACE_PATTERN=/\s/,isWindows="win32"==process.platform;function rebase(e,r){return r?isAbsolute(e)&&!isRemote(r.toBase)||isRemote(e)||isSVGMarker(e)||isInternal(e)||isDataUriResource(e)?e:isRemote(r.toBase)?url.resolve(r.toBase,e):r.absolute?normalize(absolute(e,r)):normalize(relative(e,r)):e}function isAbsolute(e){return path.isAbsolute(e)}function isSVGMarker(e){return"#"==e[0]}function isInternal(e){return/^\w+:\w+/.test(e)}function isRemote(e){return/^[^:]+?:\/\//.test(e)||PROTOCOL_LESS_PREFIX_PATTERN.test(e)}function absolute(e,r){return path.resolve(path.join(r.fromBase||"",e)).replace(r.toBase,"")}function relative(e,r){return path.relative(r.toBase,path.join(r.fromBase||"",e))}function normalize(e){return isWindows?e.replace(/\\/g,"/"):e}function quoteFor(e){return e.indexOf(SINGLE_QUOTE)>-1?DOUBLE_QUOTE:e.indexOf(DOUBLE_QUOTE)>-1||hasWhitespace(e)||hasRoundBrackets(e)?SINGLE_QUOTE:""}function hasWhitespace(e){return WHITESPACE_PATTERN.test(e)}function hasRoundBrackets(e){return ROUND_BRACKETS_PATTERN.test(e)}function rewriteUrl(e,r,t){var s=e.replace(URL_PREFIX_PATTERN,"").replace(URL_SUFFIX_PATTERN,"").trim(),i=s.replace(QUOTE_PREFIX_PATTERN,"").replace(QUOTE_SUFFIX_PATTERN,"").trim(),a=s[0]==SINGLE_QUOTE||s[0]==DOUBLE_QUOTE?s[0]:quoteFor(i);return t?rebase(i,r):URL_PREFIX+a+rebase(i,r)+a+URL_SUFFIX}module.exports=rewriteUrl;