var fs=require("fs"),path=require("path"),isAllowedResource=require("./is-allowed-resource"),hasProtocol=require("../utils/has-protocol"),isRemoteResource=require("../utils/is-remote-resource");function loadOriginalSources(e,o){var r={callback:o,fetch:e.options.fetch,index:0,inline:e.options.inline,inlineRequest:e.options.inlineRequest,inlineTimeout:e.options.inlineTimeout,localOnly:e.localOnly,rebaseTo:e.options.rebaseTo,sourcesContent:e.sourcesContent,uriToSource:uriToSourceMapping(e.inputSourceMapTracker.all()),warnings:e.warnings};return e.options.sourceMap&&e.options.sourceMapInlineSources?doLoadOriginalSources(r):o()}function uriToSourceMapping(e){var o,r,n,i,s,u={};for(n in e)for(i=0,s=(o=e[n]).sources.length;i<s;i++)r=o.sources[i],n=o.sourceContentFor(r,!0),u[r]=n;return u}function doLoadOriginalSources(e){var o,r,n,i=Object.keys(e.uriToSource);for(n=i.length;e.index<n;e.index++){if(o=i[e.index],!(r=e.uriToSource[o]))return loadOriginalSource(o,e);e.sourcesContent[o]=r}return e.callback()}function loadOriginalSource(e,o){var r;return isRemoteResource(e)?loadOriginalSourceFromRemoteUri(e,o,function(r){return o.index++,o.sourcesContent[e]=r,doLoadOriginalSources(o)}):(r=loadOriginalSourceFromLocalUri(e,o),o.index++,o.sourcesContent[e]=r,doLoadOriginalSources(o))}function loadOriginalSourceFromRemoteUri(e,o,r){var n=isAllowedResource(e,!0,o.inline),i=!hasProtocol(e);return o.localOnly?(o.warnings.push('Cannot fetch remote resource from "'+e+'" as no callback given.'),r(null)):i?(o.warnings.push('Cannot fetch "'+e+'" as no protocol given.'),r(null)):n?void o.fetch(e,o.inlineRequest,o.inlineTimeout,function(n,i){n&&o.warnings.push('Missing original source at "'+e+'" - '+n),r(i)}):(o.warnings.push('Cannot fetch "'+e+'" as resource is not allowed.'),r(null))}function loadOriginalSourceFromLocalUri(e,o){var r=isAllowedResource(e,!1,o.inline),n=path.resolve(o.rebaseTo,e);if(!fs.existsSync(n)||!fs.statSync(n).isFile())return o.warnings.push('Ignoring local source map at "'+n+'" as resource is missing.'),null;if(!r)return o.warnings.push('Cannot fetch "'+n+'" as resource is not allowed.'),null;var i=fs.readFileSync(n,"utf8");return 65279===i.charCodeAt(0)&&(i=i.substring(1)),i}module.exports=loadOriginalSources;