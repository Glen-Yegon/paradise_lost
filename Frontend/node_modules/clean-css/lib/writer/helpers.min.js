var emptyCharacter="",Breaks=require("../options/format").Breaks,Spaces=require("../options/format").Spaces,Marker=require("../tokenizer/marker"),Token=require("../tokenizer/token");function supportsAfterClosingBrace(e){return"background"==e[1][1]||"transform"==e[1][1]||"src"==e[1][1]}function afterClosingBrace(e,r){return e[r][1][e[r][1].length-1]==Marker.CLOSE_ROUND_BRACKET}function afterComma(e,r){return e[r][1]==Marker.COMMA}function afterSlash(e,r){return e[r][1]==Marker.FORWARD_SLASH}function beforeComma(e,r){return e[r+1]&&e[r+1][1]==Marker.COMMA}function beforeSlash(e,r){return e[r+1]&&e[r+1][1]==Marker.FORWARD_SLASH}function inFilter(e){return"filter"==e[1][1]||"-ms-filter"==e[1][1]}function disallowsSpace(e,r,a){return!e.spaceAfterClosingBrace&&supportsAfterClosingBrace(r)&&afterClosingBrace(r,a)||beforeSlash(r,a)||afterSlash(r,a)||beforeComma(r,a)||afterComma(r,a)}function rules(e,r){for(var a=e.store,t=0,o=r.length;t<o;t++)a(e,r[t]),t<o-1&&a(e,comma(e))}function body(e,r){for(var a=lastPropertyIndex(r),t=0,o=r.length;t<o;t++)property(e,r,t,a)}function lastPropertyIndex(e){for(var r=e.length-1;r>=0&&e[r][0]==Token.COMMENT;r--);return r}function property(e,r,a,t){var o,n=e.store,s=r[a],c=s[2],i=c&&c[0]===Token.PROPERTY_BLOCK;o=e.format?!(!e.format.semicolonAfterLastProperty&&!i)||a<t:a<t||i;var k=a===t;switch(s[0]){case Token.AT_RULE:n(e,s),n(e,semicolon(e,Breaks.AfterProperty,!1));break;case Token.AT_RULE_BLOCK:rules(e,s[1]),n(e,openBrace(e,Breaks.AfterRuleBegins,!0)),body(e,s[2]),n(e,closeBrace(e,Breaks.AfterRuleEnds,!1,k));break;case Token.COMMENT:n(e,s),n(e,breakFor(e,Breaks.AfterComment)+e.indentWith);break;case Token.PROPERTY:n(e,s[1]),n(e,colon(e)),c&&value(e,s),n(e,o?semicolon(e,Breaks.AfterProperty,k):emptyCharacter);break;case Token.RAW:n(e,s)}}function value(e,r){var a,t,o=e.store;if(r[2][0]==Token.PROPERTY_BLOCK)o(e,openBrace(e,Breaks.AfterBlockBegins,!1)),body(e,r[2][1]),o(e,closeBrace(e,Breaks.AfterBlockEnds,!1,!0));else for(a=2,t=r.length;a<t;a++)o(e,r[a]),a<t-1&&(inFilter(r)||!disallowsSpace(e,r,a))&&o(e,Marker.SPACE)}function breakFor(e,r){return e.format?e.format.breaks[r]:emptyCharacter}function allowsSpace(e,r){return e.format&&e.format.spaces[r]}function openBrace(e,r,a){return e.format?(e.indentBy+=e.format.indentBy,e.indentWith=e.format.indentWith.repeat(e.indentBy),(a&&allowsSpace(e,Spaces.BeforeBlockBegins)?Marker.SPACE:emptyCharacter)+Marker.OPEN_CURLY_BRACKET+breakFor(e,r)+e.indentWith):Marker.OPEN_CURLY_BRACKET}function closeBrace(e,r,a,t){return e.format?(e.indentBy-=e.format.indentBy,e.indentWith=e.format.indentWith.repeat(e.indentBy),breakFor(e,a?Breaks.BeforeBlockEnds:Breaks.AfterProperty)+e.indentWith+Marker.CLOSE_CURLY_BRACKET+(t?emptyCharacter:breakFor(e,r)+e.indentWith)):Marker.CLOSE_CURLY_BRACKET}function colon(e){return e.format?Marker.COLON+(allowsSpace(e,Spaces.BeforeValue)?Marker.SPACE:emptyCharacter):Marker.COLON}function semicolon(e,r,a){return e.format?Marker.SEMICOLON+(a?emptyCharacter:breakFor(e,r)+e.indentWith):Marker.SEMICOLON}function comma(e){return e.format?Marker.COMMA+breakFor(e,Breaks.BetweenSelectors)+e.indentWith:Marker.COMMA}function all(e,r){var a,t,o,n,s=e.store;for(o=0,n=r.length;o<n;o++)switch(t=o==n-1,(a=r[o])[0]){case Token.AT_RULE:s(e,a),s(e,semicolon(e,Breaks.AfterAtRule,t));break;case Token.AT_RULE_BLOCK:rules(e,a[1]),s(e,openBrace(e,Breaks.AfterRuleBegins,!0)),body(e,a[2]),s(e,closeBrace(e,Breaks.AfterRuleEnds,!1,t));break;case Token.NESTED_BLOCK:rules(e,a[1]),s(e,openBrace(e,Breaks.AfterBlockBegins,!0)),all(e,a[2]),s(e,closeBrace(e,Breaks.AfterBlockEnds,!0,t));break;case Token.COMMENT:s(e,a),s(e,breakFor(e,Breaks.AfterComment)+e.indentWith);break;case Token.RAW:s(e,a);break;case Token.RULE:rules(e,a[1]),s(e,openBrace(e,Breaks.AfterRuleBegins,!0)),body(e,a[2]),s(e,closeBrace(e,Breaks.AfterRuleEnds,!1,t))}}module.exports={all:all,body:body,property:property,rules:rules,value:value};