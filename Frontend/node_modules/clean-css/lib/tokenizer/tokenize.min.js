var Marker=require("./marker"),Token=require("./token"),formatPosition=require("../utils/format-position"),Level={BLOCK:"block",COMMENT:"comment",DOUBLE_QUOTE:"double-quote",RULE:"rule",SINGLE_QUOTE:"single-quote"},AT_RULES=["@charset","@import"],BLOCK_RULES=["@-moz-document","@document","@-moz-keyframes","@-ms-keyframes","@-o-keyframes","@-webkit-keyframes","@keyframes","@media","@supports","@container","@layer"],IGNORE_END_COMMENT_PATTERN=/\/\* clean-css ignore:end \*\/$/,IGNORE_START_COMMENT_PATTERN=/^\/\* clean-css ignore:start \*\//,PAGE_MARGIN_BOXES=["@bottom-center","@bottom-left","@bottom-left-corner","@bottom-right","@bottom-right-corner","@left-bottom","@left-middle","@left-top","@right-bottom","@right-middle","@right-top","@top-center","@top-left","@top-left-corner","@top-right","@top-right-corner"],EXTRA_PAGE_BOXES=["@footnote","@footnotes","@left","@page-float-bottom","@page-float-top","@right"],REPEAT_PATTERN=/^\[\s{0,31}\d+\s{0,31}\]$/,TAIL_BROKEN_VALUE_PATTERN=/([^}])\}*$/,RULE_WORD_SEPARATOR_PATTERN=/[\s(]/;function tokenize(e,r){return intoTokens(e,r,{level:Level.BLOCK,position:{source:r.source||void 0,line:1,column:0,index:0}},!1)}function intoTokens(e,r,n,o){for(var i,E,l,t,a,L,R,T,s,O,M,p,_,u,k,C,A,U=[],h=U,S=[],N=[],f=n.level,m=[],g=[],v=[],P=!0,B=0,c=!1,d=!1,K=!1,I=!1,D=!1,Y=!1,j=!1,x=n.position;x.index<e.length;x.index++){var G=e[x.index];if(R=f==Level.SINGLE_QUOTE||f==Level.DOUBLE_QUOTE,T=G==Marker.SPACE||G==Marker.TAB,s=G==Marker.NEW_LINE_NIX,O=G==Marker.NEW_LINE_NIX&&e[x.index-1]==Marker.CARRIAGE_RETURN,M=G==Marker.CARRIAGE_RETURN&&e[x.index+1]&&e[x.index+1]!=Marker.NEW_LINE_NIX,p=!d&&f!=Level.COMMENT&&!R&&G==Marker.ASTERISK&&e[x.index-1]==Marker.FORWARD_SLASH,u=!c&&!R&&G==Marker.FORWARD_SLASH&&e[x.index-1]==Marker.ASTERISK,_=f==Level.COMMENT&&u,C=!T&&!M&&(G>="A"&&G<="Z"||G>="a"&&G<="z"||G>="0"&&G<="9"||"-"==G),I=I||f!=Level.COMMENT&&!Y&&K&&"-"===G&&1===g.length,K="-"===G,B=Math.max(B,0),t=P?[x.line,x.column,x.source]:t,k)g.push(G),P=!1;else if(C)g.push(G),P=!1;else if((T||s&&!O)&&(R||f==Level.COMMENT))g.push(G),P=!1;else if((T||s&&!O)&&P);else if(_||f!=Level.COMMENT)if(p||_||!D)if(p&&I&&(f==Level.BLOCK||f==Level.RULE)&&g.length>1)g.push(G),P=!1,m.push(f),f=Level.COMMENT;else if(p&&(f==Level.BLOCK||f==Level.RULE)&&g.length>1)N.push(t),g.push(G),v.push(g.slice(0,-2)),P=!1,g=g.slice(-2),t=[x.line,x.column-1,x.source],m.push(f),f=Level.COMMENT;else if(p)m.push(f),f=Level.COMMENT,g.push(G),P=!1;else if(_&&I)g.push(G),f=m.pop();else if(_&&isIgnoreStartComment(g))a=g.join("").trim()+G,i=[Token.COMMENT,a,[originalMetadata(t,a,r)]],h.push(i),D=!0,t=N.pop()||null,P=0===(g=v.pop()||[]).length;else if(_&&isIgnoreEndComment(g))A=(a=g.join("")+G).lastIndexOf(Marker.FORWARD_SLASH+Marker.ASTERISK),L=a.substring(0,A),i=[Token.RAW,L,[originalMetadata(t,L,r)]],h.push(i),L=a.substring(A),t=[x.line,x.column-L.length+1,x.source],i=[Token.COMMENT,L,[originalMetadata(t,L,r)]],h.push(i),D=!1,f=m.pop(),t=N.pop()||null,P=0===(g=v.pop()||[]).length;else if(_)a=g.join("").trim()+G,i=[Token.COMMENT,a,[originalMetadata(t,a,r)]],h.push(i),f=m.pop(),t=N.pop()||null,P=0===(g=v.pop()||[]).length;else if(u&&e[x.index+1]!=Marker.ASTERISK)r.warnings.push("Unexpected '*/' at "+formatPosition([x.line,x.column,x.source])+"."),g=[],P=!0;else if(G!=Marker.SINGLE_QUOTE||R)if(G==Marker.SINGLE_QUOTE&&f==Level.SINGLE_QUOTE)f=m.pop(),g.push(G),P=!1;else if(G!=Marker.DOUBLE_QUOTE||R)if(G==Marker.DOUBLE_QUOTE&&f==Level.DOUBLE_QUOTE)f=m.pop(),g.push(G),P=!1;else if(G!=Marker.CLOSE_ROUND_BRACKET&&G!=Marker.OPEN_ROUND_BRACKET&&f!=Level.COMMENT&&!R&&B>0)g.push(G),P=!1;else if(G!=Marker.OPEN_ROUND_BRACKET||R||f==Level.COMMENT||Y)if(G!=Marker.CLOSE_ROUND_BRACKET||R||f==Level.COMMENT||Y)if(G==Marker.SEMICOLON&&f==Level.BLOCK&&g[0]==Marker.AT)a=g.join("").trim(),U.push([Token.AT_RULE,a,[originalMetadata(t,a,r)]]),g=[],P=!0;else if(G==Marker.COMMA&&f==Level.BLOCK&&E)a=g.join("").trim(),E[1].push([tokenScopeFrom(E[0]),a,[originalMetadata(t,a,r,E[1].length)]]),g=[],P=!0;else if(G==Marker.COMMA&&f==Level.BLOCK&&tokenTypeFrom(g)==Token.AT_RULE)g.push(G),P=!1;else if(G==Marker.COMMA&&f==Level.BLOCK)E=[tokenTypeFrom(g),[],[]],a=g.join("").trim(),E[1].push([tokenScopeFrom(E[0]),a,[originalMetadata(t,a,r,0)]]),g=[],P=!0;else if(G==Marker.OPEN_CURLY_BRACKET&&f==Level.BLOCK&&E&&E[0]==Token.NESTED_BLOCK)a=g.join("").trim(),E[1].push([Token.NESTED_BLOCK_SCOPE,a,[originalMetadata(t,a,r)]]),U.push(E),m.push(f),x.column++,x.index++,g=[],P=!0,E[2]=intoTokens(e,r,n,!0),E=null;else if(G==Marker.OPEN_CURLY_BRACKET&&f==Level.BLOCK&&tokenTypeFrom(g)==Token.NESTED_BLOCK)a=g.join("").trim(),(E=E||[Token.NESTED_BLOCK,[],[]])[1].push([Token.NESTED_BLOCK_SCOPE,a,[originalMetadata(t,a,r)]]),U.push(E),m.push(f),x.column++,x.index++,g=[],P=!0,I=!1,E[2]=intoTokens(e,r,n,!0),E=null;else if(G==Marker.OPEN_CURLY_BRACKET&&f==Level.BLOCK)a=g.join("").trim(),(E=E||[tokenTypeFrom(g),[],[]])[1].push([tokenScopeFrom(E[0]),a,[originalMetadata(t,a,r,E[1].length)]]),h=E[2],U.push(E),m.push(f),f=Level.RULE,g=[],P=!0;else if(G==Marker.OPEN_CURLY_BRACKET&&f==Level.RULE&&Y)S.push(E),E=[Token.PROPERTY_BLOCK,[]],l.push(E),h=E[1],m.push(f),f=Level.RULE,Y=!1;else if(G==Marker.OPEN_CURLY_BRACKET&&f==Level.RULE&&isPageMarginBox(g))a=g.join("").trim(),S.push(E),(E=[Token.AT_RULE_BLOCK,[],[]])[1].push([Token.AT_RULE_BLOCK_SCOPE,a,[originalMetadata(t,a,r)]]),h.push(E),h=E[2],m.push(f),f=Level.RULE,g=[],P=!0;else if(G!=Marker.COLON||f!=Level.RULE||Y)if(G==Marker.SEMICOLON&&f==Level.RULE&&l&&S.length>0&&!P&&g[0]==Marker.AT)a=g.join("").trim(),E[1].push([Token.AT_RULE,a,[originalMetadata(t,a,r)]]),g=[],P=!0;else if(G==Marker.SEMICOLON&&f==Level.RULE&&l&&!P)a=g.join("").trim(),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),l=null,Y=!1,g=[],P=!0,I=!1;else if(G==Marker.SEMICOLON&&f==Level.RULE&&l&&P&&I&&!l[2])l.push([Token.PROPERTY_VALUE," ",[originalMetadata(t," ",r)]]),I=!1,l=null,Y=!1;else if(G==Marker.SEMICOLON&&f==Level.RULE&&l&&P)l=null,Y=!1;else if(G!=Marker.SEMICOLON||f!=Level.RULE||P||g[0]!=Marker.AT)if(G==Marker.SEMICOLON&&f==Level.RULE&&j)j=!1,g=[],P=!0;else if(G==Marker.SEMICOLON&&f==Level.RULE&&P);else if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.RULE&&l&&Y&&!P&&S.length>0)a=g.join(""),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),l=null,h=(E=S.pop())[2],f=m.pop(),Y=!1,g=[],P=!0;else if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.RULE&&l&&!P&&g[0]==Marker.AT&&S.length>0)a=g.join(""),E[1].push([Token.AT_RULE,a,[originalMetadata(t,a,r)]]),l=null,h=(E=S.pop())[2],f=m.pop(),Y=!1,g=[],P=!0;else if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.RULE&&l&&S.length>0)l=null,h=(E=S.pop())[2],f=m.pop(),Y=!1;else if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.RULE&&l&&!P)a=g.join(""),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),l=null,E=S.pop(),h=U,f=m.pop(),Y=!1,g=[],P=!0;else if(G!=Marker.CLOSE_CURLY_BRACKET||f!=Level.RULE||P||g[0]!=Marker.AT)if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.RULE&&m[m.length-1]==Level.RULE)l=null,h=(E=S.pop())[2],f=m.pop(),Y=!1,j=!0,g=[],P=!0;else if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.RULE&&I&&l&&!l[2])l.push([Token.PROPERTY_VALUE," ",[originalMetadata(t," ",r)]]),I=!1,l=null,E=null,h=U,f=m.pop(),Y=!1,I=!1;else if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.RULE)l=null,E=null,h=U,f=m.pop(),Y=!1,I=!1;else if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.BLOCK&&!o&&x.index<=e.length-1)r.warnings.push("Unexpected '}' at "+formatPosition([x.line,x.column,x.source])+"."),g.push(G),P=!1;else{if(G==Marker.CLOSE_CURLY_BRACKET&&f==Level.BLOCK)break;G==Marker.OPEN_ROUND_BRACKET&&f==Level.RULE&&Y?(g.push(G),P=!1,B++):G==Marker.CLOSE_ROUND_BRACKET&&f==Level.RULE&&Y&&1==B?(g.push(G),P=!1,a=g.join("").trim(),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),B--,g=[],P=!0,I=!1):G==Marker.CLOSE_ROUND_BRACKET&&f==Level.RULE&&Y?(g.push(G),P=!1,I=!1,B--):G==Marker.FORWARD_SLASH&&e[x.index+1]!=Marker.ASTERISK&&f==Level.RULE&&Y&&!P?(a=g.join("").trim(),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),l.push([Token.PROPERTY_VALUE,G,[[x.line,x.column,x.source]]]),g=[],P=!0):G==Marker.FORWARD_SLASH&&e[x.index+1]!=Marker.ASTERISK&&f==Level.RULE&&Y?(l.push([Token.PROPERTY_VALUE,G,[[x.line,x.column,x.source]]]),g=[],P=!0):G==Marker.COMMA&&f==Level.RULE&&Y&&!P?(a=g.join("").trim(),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),l.push([Token.PROPERTY_VALUE,G,[[x.line,x.column,x.source]]]),g=[],P=!0):G==Marker.COMMA&&f==Level.RULE&&Y?(l.push([Token.PROPERTY_VALUE,G,[[x.line,x.column,x.source]]]),g=[],P=!0):G==Marker.CLOSE_SQUARE_BRACKET&&l&&l.length>1&&!P&&isRepeatToken(g)?(g.push(G),a=g.join("").trim(),l[l.length-1][1]+=a,g=[],P=!0):(T||s&&!O)&&f==Level.RULE&&Y&&l&&!P||O&&f==Level.RULE&&Y&&l&&g.length>1?(a=g.join("").trim(),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),g=[],P=!0):O&&f==Level.RULE&&Y?(g=[],P=!0):O&&1==g.length?(g.pop(),P=0===g.length):P&&(T||s||O||M)||(g.push(G),P=!1)}else l=null,E=null,a=g.join("").trim(),h.push([Token.AT_RULE,a,[originalMetadata(t,a,r)]]),h=U,f=m.pop(),Y=!1,g=[],P=!0;else a=g.join(""),h.push([Token.AT_RULE,a,[originalMetadata(t,a,r)]]),Y=!1,g=[],P=!0;else a=g.join("").trim(),l=[Token.PROPERTY,[Token.PROPERTY_NAME,a,[originalMetadata(t,a,r)]]],h.push(l),Y=!0,g=[],P=!0;else g.push(G),P=!1,B--;else g.push(G),P=!1,B++;else m.push(f),f=Level.DOUBLE_QUOTE,g.push(G),P=!1;else m.push(f),f=Level.SINGLE_QUOTE,g.push(G),P=!1;else g.push(G),P=!1;else g.push(G),P=!1;k=!k&&G==Marker.BACK_SLASH,c=p,d=_,x.line=O||s||M?x.line+1:x.line,x.column=O||s||M?0:x.column+1}return Y&&r.warnings.push("Missing '}' at "+formatPosition([x.line,x.column,x.source])+"."),Y&&g.length>0&&(a=g.join("").trimRight().replace(TAIL_BROKEN_VALUE_PATTERN,"$1").trimRight(),l.push([Token.PROPERTY_VALUE,a,[originalMetadata(t,a,r)]]),g=[]),g.length>0&&r.warnings.push("Invalid character(s) '"+g.join("")+"' at "+formatPosition(t)+". Ignoring."),U}function isIgnoreStartComment(e){return IGNORE_START_COMMENT_PATTERN.test(e.join("")+Marker.FORWARD_SLASH)}function isIgnoreEndComment(e){return IGNORE_END_COMMENT_PATTERN.test(e.join("")+Marker.FORWARD_SLASH)}function originalMetadata(e,r,n,o){var i=e[2];return n.inputSourceMapTracker.isTracking(i)?n.inputSourceMapTracker.originalPositionFor(e,r.length,o):e}function tokenTypeFrom(e){var r=e[0]==Marker.AT||e[0]==Marker.UNDERSCORE,n=e.join("").split(RULE_WORD_SEPARATOR_PATTERN)[0];return r&&BLOCK_RULES.indexOf(n)>-1?Token.NESTED_BLOCK:r&&AT_RULES.indexOf(n)>-1?Token.AT_RULE:r?Token.AT_RULE_BLOCK:Token.RULE}function tokenScopeFrom(e){return e==Token.RULE?Token.RULE_SCOPE:e==Token.NESTED_BLOCK?Token.NESTED_BLOCK_SCOPE:e==Token.AT_RULE_BLOCK?Token.AT_RULE_BLOCK_SCOPE:void 0}function isPageMarginBox(e){var r=e.join("").trim();return PAGE_MARGIN_BOXES.indexOf(r)>-1||EXTRA_PAGE_BOXES.indexOf(r)>-1}function isRepeatToken(e){return REPEAT_PATTERN.test(e.join("")+Marker.CLOSE_SQUARE_BRACKET)}module.exports=tokenize;